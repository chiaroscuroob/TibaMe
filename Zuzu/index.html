import React, { useState, useEffect, useRef } from 'react';
import { 
  MessageSquare, 
  Calendar as CalendarIcon, 
  Users, 
  LayoutDashboard, 
  CheckCircle, 
  Send, 
  Sparkles, 
  Clock, 
  TrendingUp,
  Settings,
  Bell,
  Edit3,
  Search,
  MoreHorizontal,
  ThumbsUp,
  Instagram,
  ChevronLeft,
  ChevronRight,
  Phone,
  Mail,
  X,
  Globe,
  RefreshCw,
  FileText,     
  Database,     
  AlertCircle,
  Save,
  Bot,
  MessageCircle,
  ArrowUpRight,
  MapPin,
  Filter,
  List,
  Image as ImageIcon,
  UploadCloud,
  Loader2,
  BarChart2,
  Zap,
  Award,
  ClipboardList,
  Info,
  Lightbulb,
  DollarSign,
  PieChart,
  CreditCard,
  Gift,
  Link as LinkIcon,
  BrainCircuit,
  TrendingDown,
  AlertTriangle,
  Target,
  ExternalLink,
  CalendarPlus,
  Plug, 
  CheckSquare, 
  Home,
  Megaphone, // For Marketing Messages
  UserPlus,  // For Influencers
  MousePointer2, // For Ads
  ShoppingCart, // For Shopify
  Workflow, // For Zapier
  Mail as MailIcon // For Mailchimp
} from 'lucide-react';

// --- API CONFIGURATION ---
const apiKey = ""; // API key is injected by the environment

async function callGemini(prompt) {
  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        }),
      }
    );
    
    if (!response.ok) {
        const errorData = await response.json();
        console.error("Gemini API Error:", errorData);
        throw new Error("API request failed");
    }

    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "AI æš«æ™‚ç„¡æ³•å›æ‡‰ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
  } catch (error) {
    console.error("Error calling Gemini:", error);
    return "AI é€£ç·šç•°å¸¸ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API è¨­å®šã€‚";
  }
}

// --- 1. Logo Component ---
const ZuZuLogo = ({ size = 40 }) => (
  <svg width={size} height={size} viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
    <circle cx="30" cy="50" r="28" fill="#F97316" />
    <circle cx="70" cy="50" r="28" fill="#FACC15" fillOpacity="0.9" style={{ mixBlendMode: 'normal' }} /> 
    <circle cx="22" cy="45" r="4" fill="white" />
    <circle cx="38" cy="45" r="4" fill="white" />
    <circle cx="62" cy="45" r="4" fill="white" />
    <circle cx="78" cy="45" r="4" fill="white" />
    <path d="M22 62 Q 50 85 78 62" stroke="white" strokeWidth="5" strokeLinecap="round" />
    <path d="M90 15 L92 20 L97 22 L92 24 L90 29 L88 24 L83 22 L88 20 Z" fill="#F97316" />
    <path d="M95 35 L96 37 L98 38 L96 39 L95 41 L94 39 L92 38 L94 37 Z" fill="#FACC15" />
  </svg>
);

// --- Icons ---
const PlatformIcon = ({ platform }) => {
  switch (platform) {
    case 'Instagram': return <Instagram className="w-3 h-3 text-pink-600" />;
    case 'Threads': return <svg viewBox="0 0 24 24" fill="currentColor" className="w-3 h-3 text-black"><path d="M12.012 1.625C6.188 1.625 1.625 6.275 1.625 12.012S6.275 22.4 12.012 22.4c5.738 0 10.388-4.65 10.388-10.388 0-1.163-.175-2.287-.5-3.362-.2-.688-.863-1.075-1.55-.863-.688.2-1.075.863-.863 1.55.263.863.4 1.775.4 2.7 0 4.413-3.575 7.988-7.988 7.988-4.413 0-7.988-3.575-7.988-7.988 0-4.413 3.575-7.988 7.988-7.988.75 0 1.488.1 2.2.3.837.237 1.7.025 2.287-.563.587-.587.8-1.45.563-2.287-.5-1.75-2.113-3-4.013-3-2.3 0-4.175 1.875-4.175 4.175v.2c0 .825.675 1.5 1.5 1.5.825 0 1.5-.675 1.5-1.5v-.2c0-.65.525-1.175 1.175-1.175.65 0 1.175.525 1.175 1.175 0 1.275-1.037 2.313-2.313 2.313-1.275 0-2.313-1.037-2.313-2.313 0-3.95 3.213-7.175 7.175-7.175s7.175 3.213 7.175 7.175c0 3.95-3.213 7.175-7.175 7.175-3.95 0-7.175-3.213-7.175-7.175 0-3.95 3.213-7.175 7.175-7.175z" /></svg>;
    case 'LINE': default: return <div className="w-3 h-3 bg-green-500 rounded-full flex items-center justify-center text-[8px] text-white font-bold">L</div>;
  }
};

// --- DATA ---
const CURRENT_DATE = "2025-11-14";

const INITIAL_MESSAGES = [
  { 
    id: 101, 
    client: "Kevin æ—", 
    avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Kevin", 
    platform: "Threads", 
    lastMessage: "ä½ å€‘çš„ç³»çµ±å¯ä»¥ä¸²æ¥ Notion å—ï¼Ÿ", 
    time: "5åˆ†é˜å‰", 
    status: "pending_review", 
    aiDraftIndex: 0, 
    history: [
      { sender: "client", text: "ä½ å€‘çš„ç³»çµ±å¯ä»¥ä¸²æ¥ Notion å—ï¼Ÿæˆ‘åœ¨ Threads ä¸Šçœ‹åˆ°ä»‹ç´¹è¦ºå¾—å¾ˆé…·ï¼", time: "10:30" }
    ] 
  },
  { id: 102, client: "Jessica Wang", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Jessica", platform: "LINE", lastMessage: "æˆ‘æƒ³é ç´„ä¸‹é€±ä¸‰ä¸‹åˆå…©é»çš„ç·šä¸Šè«®è©¢ã€‚", time: "35åˆ†é˜å‰", status: "pending_review", aiDraftIndex: 0, history: [{ sender: "client", text: "æˆ‘æƒ³é ç´„ä¸‹é€±ä¸‰ä¸‹åˆå…©é»çš„ç·šä¸Šè«®è©¢ã€‚", time: "10:00" }] },
  { id: 103, client: "Bella", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Bella", platform: "Instagram", lastMessage: "å¤ªæ£’äº†ï¼æ„Ÿè¬ä½ çš„æ¨è–¦ï¼", time: "1å°æ™‚å‰", status: "replied", aiDraftIndex: 0, history: [{ sender: "client", text: "è«‹å•æœ‰é©åˆç¾å¦ç”¢æ¥­çš„è‡ªå‹•åŒ–ç¯„ä¾‹å—ï¼Ÿæƒ³äº†è§£ï½", time: "09:15" }, { sender: "ai", text: "Bella å¦³å¥½ï¼ğŸ’„ æˆ‘å€‘æœ‰å°ˆé–€ç‚ºç¾æ¥­/ç¾å¦è¨­è¨ˆçš„è‡ªå‹•åŒ–æµç¨‹å–”ï¼åŒ…å«è‡ªå‹•ç™¼é€ä½œå“é›†ã€é ç´„æé†’ç­‰ç­‰ã€‚", time: "09:16" }, { sender: "client", text: "å¤ªæ£’äº†ï¼æ„Ÿè¬ä½ çš„æ¨è–¦ï¼", time: "09:20" }] },
  { id: 104, client: "Tom Wu", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Tom", platform: "LINE", lastMessage: "è«‹å•å·¥ä½œå®¤åœ°é»åœ¨å“ªè£¡ï¼Ÿ", time: "2å°æ™‚å‰", status: "replied", aiDraftIndex: 0, history: [{ sender: "client", text: "è«‹å•å·¥ä½œå®¤åœ°é»åœ¨å“ªè£¡ï¼Ÿ", time: "08:30" }, { sender: "ai", text: "Tom æ‚¨å¥½ï¼Œæˆ‘å€‘ä½æ–¼å°åŒ—å¸‚å¤§å®‰å€ä¿¡ç¾©è·¯ä¸‰æ®µ 100 è™Ÿï¼Œæ·é‹å¤§å®‰æ£®æ—å…¬åœ’ç«™å‡ºå£æ­¥è¡Œ 3 åˆ†é˜å³å¯æŠµé” ğŸ“", time: "08:30" }] },
  { id: 105, client: "Amy", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Amy", platform: "Instagram", lastMessage: "æˆ‘æƒ³è©¢å•é—œæ–¼ã€Œç¾æ¥­å°ˆç”¨åŒ…ã€çš„åƒ¹æ ¼ã€‚", time: "3å°æ™‚å‰", status: "pending_review", aiDraftIndex: 0, history: [{ sender: "client", text: "æˆ‘æƒ³è©¢å•é—œæ–¼ã€Œç¾æ¥­å°ˆç”¨åŒ…ã€çš„åƒ¹æ ¼ã€‚", time: "07:45" }] },
];

const AI_DRAFT_VARIANTS = {
  101: ["å—¨ Kevinï¼ğŸ‘‹ æ²’å•é¡Œï¼ŒZuZu é€é n8n å¯ä»¥è¼•é¬†å°‡è³‡æ–™å¯«å…¥ Notion è³‡æ–™åº«ã€‚é€™é€±æ–¹ä¾¿ç´„å€‹æ™‚é–“å±•ç¤ºçµ¦æ‚¨çœ‹å—ï¼ŸğŸ˜Š"],
  102: ["Jessica æ‚¨å¥½ï¼Œæ„Ÿè¬é ç´„ï¼ä¸‹é€±ä¸‰ 14:00 çš„è«®è©¢æ™‚é–“æ²’å•é¡Œã€‚æœƒè­°é€£çµæœƒé€é Email å¯„çµ¦æ‚¨ã€‚æœŸå¾…èˆ‡æ‚¨è¨è«–ï¼ğŸš€"],
  105: ["Amy æ‚¨å¥½ï¼ğŸ’… æˆ‘å€‘çš„ã€Œç¾æ¥­å°ˆç”¨åŒ…ã€ç›®å‰æœ‰æ—©é³¥å„ªæƒ  NT$12,000 (å«ä¸€æ¬¡æ€§è¨­å®šè²»)ã€‚é€™å€‹æ–¹æ¡ˆåŒ…å«é ç´„ç³»çµ±ã€ä½œå“é›†æ¨æ’­èˆ‡è¡“å¾Œé—œæ‡·æ¨¡çµ„ã€‚æœ‰èˆˆè¶£äº†è§£æ›´å¤šåŠŸèƒ½å—ï¼Ÿ"]
};

const CLIENTS_DB = [
  { id: 1, name: "Kevin æ—", phone: "0912-345-678", email: "kevin@tech.com", company: "å€‹äººæ¥æ¡ˆè¨­è¨ˆå¸«", status: "æ´½è«‡ä¸­", lastContact: "2025-11-14", source: "Threads", totalSpent: 0, visits: 1, tags: ["å° n8n æœ‰èˆˆè¶£", "é ç®—å……è¶³"], industry: "è¨­è¨ˆ", plan: "Lite", notes: "å®¢æˆ¶å° Notion ä¸²æ¥æœ‰é«˜åº¦èˆˆè¶£ã€‚", history: [{date: "2025-11-14", event: "Threads ç§è¨Š"}] },
  { id: 2, name: "Jessica Wang", phone: "0988-777-666", email: "jessica@studio.com", company: "æ™¨æ›¦ç‘œçˆå·¥ä½œå®¤", status: "å·²ç°½ç´„", lastContact: "2025-11-14", source: "LINE æœå°‹", totalSpent: 12000, visits: 5, tags: ["æ€¥éœ€é ç´„åŠŸèƒ½", "Pro æ–¹æ¡ˆ", "é«˜åƒ¹å€¼"], industry: "é‹å‹•/å¥åº·", plan: "Pro", notes: "æ—§ Email å¯èƒ½å·²åœç”¨ï¼Œå¾…ç¡®è®¤ã€‚", history: [{date: "2025-11-14", event: "å¡«å¯«è«®è©¢å•å·"}] },
  { id: 3, name: "Bella", phone: "0922-333-444", email: "bella@fashion.tw", company: "è‡ªåª’é«”", status: "æ½›åœ¨", lastContact: "2025-11-14", source: "Instagram", totalSpent: 0, visits: 1, tags: ["IG ç¶²ç´…", "ç¾å¦", "äº’æƒ åˆä½œ"], industry: "åª’é«”", plan: "None", notes: "è©¢å•ç¾æ¥­è‡ªå‹•åŒ–æ¡ˆä¾‹ï¼Œè€ƒæ…®äº’æƒ æ¨å»£ã€‚", history: [{date: "2025-11-14", event: "IG ç§è¨Š"}] },
  { id: 4, name: "Tom Wu", phone: "0955-123-456", email: "tom@gmail.com", company: "è‡ªç”±æ¥­", status: "æ½›åœ¨", lastContact: "2025-11-14", source: "LINE", totalSpent: 0, visits: 1, tags: ["è«®è©¢åœ°é»"], industry: "å…¶ä»–", plan: "None", notes: "è©¢å•äº¤é€šæ–¹å¼ã€‚", history: [{date: "2025-11-14", event: "LINE è©¢å•"}] },
  { id: 5, name: "Amy", phone: "0966-888-999", email: "amy@nail.studio", company: "è‰¾å’ªç¾ç”²", status: "æ´½è«‡ä¸­", lastContact: "2025-11-14", source: "Instagram", totalSpent: 0, visits: 1, tags: ["ç¾æ¥­", "è©¢åƒ¹"], industry: "ç¾æ¥­", plan: "Lite", notes: "å°åƒ¹æ ¼æ•æ„Ÿã€‚", history: [{date: "2025-11-14", event: "IG è©¢åƒ¹"}] },
  { id: 6, name: "Mike å¥èº«æ•™ç·´", phone: "0911-222-333", email: "mike@gym.com", company: "Mike Fitness", status: "å·²ç°½ç´„", lastContact: "2025-11-13", source: "Instagram", totalSpent: 24000, visits: 8, tags: ["å¥èº«", "è‡ªå‹•æ’èª²"], industry: "é‹å‹•/å¥åº·", plan: "Pro", notes: "æ»¿æ„åº¦é«˜ã€‚", history: [{date: "2025-11-13", event: "ç³»çµ±è¨­å®šå®Œæˆ"}] }
];

const ALL_DATA = [
  { id: 1, date: "2025-11-14", time: "10:00", client: "Kevin æ—", service: "ç³»çµ±æ¶æ§‹è«®è©¢", status: "upcoming", industry: "è¨­è¨ˆ", plan: "Lite", payment: "unpaid", amount: 1500, method: "è½‰å¸³" },
  { id: 2, date: "2025-11-14", time: "14:00", client: "Jessica Wang", service: "ZuZu å°å…¥æ•™å­¸", status: "confirmed", industry: "é‹å‹•/å¥åº·", plan: "Pro", payment: "paid", amount: 3000, method: "LINE Pay" },
  { id: 3, date: "2025-11-14", time: "16:00", client: "Bella", service: "ç¾æ¥­è‡ªå‹•åŒ–Demo", status: "pending", industry: "åª’é«”", plan: "None", payment: "unpaid", amount: 0, method: "-" },
  { id: 4, date: "2025-11-15", time: "11:00", client: "Tom Wu", service: "ç¾å ´è«®è©¢", status: "upcoming", industry: "å…¶ä»–", plan: "None", payment: "unpaid", amount: 1500, method: "ç¾é‡‘" },
  { id: 5, date: "2025-11-16", time: "15:00", client: "Sarah é™³", service: "é€²éšåŠŸèƒ½è¨­å®š", status: "confirmed", industry: "è¨­è¨ˆ", plan: "Pro", payment: "paid", amount: 5000, method: "ä¿¡ç”¨å¡" },
  { id: 6, date: "2025-11-18", time: "13:30", client: "Mike å¥èº«æ•™ç·´", service: "å®šæœŸå›è¨ª", status: "confirmed", industry: "é‹å‹•/å¥åº·", plan: "Pro", payment: "paid", amount: 0, method: "-" },
  { id: 7, date: "2025-11-05", time: "10:00", client: "Amy", service: "ç¾æ¥­è«®è©¢", status: "completed", industry: "ç¾æ¥­", plan: "Lite", payment: "paid", amount: 1500, method: "LINE Pay" },
  { id: 8, date: "2025-11-08", time: "14:00", client: "Mike", service: "ç³»çµ±è¨­å®š", status: "completed", industry: "é‹å‹•/å¥åº·", plan: "Pro", payment: "paid", amount: 3000, method: "è½‰å¸³" },
];

const CRAWLED_ARTICLES = [
  { id: 1, sourceType: 'news', source: "TechNews ç§‘æŠ€æ–°å ±", title: "2025 å¹´åå¤§ N8N è‡ªå‹•åŒ–è¶¨å‹¢", summary: "æ¢è¨ AI Agent çµåˆ n8n å¦‚ä½•åœ¨å®¢æˆ¶æœå‹™ã€è¡ŒéŠ·è‡ªå‹•åŒ–é ˜åŸŸç¯€çœ 80% äººåŠ›æˆæœ¬...", date: "2025-11-13", tags: ["è‡ªå‹•åŒ–", "AIè¶¨å‹¢"], content: "éš¨è‘— AI æŠ€è¡“çš„æˆç†Ÿï¼ŒNo-Code è‡ªå‹•åŒ–å·¥å…· n8n æ­£æˆç‚ºä¸€äººå…¬å¸çš„é¦–é¸ã€‚æœ¬æ–‡å°‡æ·±å…¥æ¢è¨å¦‚ä½•åˆ©ç”¨ n8n ä¸²æ¥ OpenAI èˆ‡ LINEï¼Œå¯¦ç¾å…¨è‡ªå‹•åŒ–çš„å®¢æˆ¶æœå‹™æµç¨‹ã€‚\n\n1. è‡ªå‹•åŒ–å®¢æœï¼š\né€é n8n çš„ AI Agent ç¯€é»ï¼Œå¯ä»¥è®“ LINE å®˜æ–¹å¸³è™Ÿå…·å‚™ 24 å°æ™‚å›æ‡‰èƒ½åŠ›ï¼Œä¸å†éŒ¯å¤±ä»»ä½•æ½›åœ¨å®¢æˆ¶ã€‚\n\n2. è·¨å¹³å°æ•´åˆï¼š\né™¤äº† LINEï¼Œn8n é‚„èƒ½è¼•é¬†ä¸²æ¥ Google Calendarã€Notionã€Stripe ç­‰å·¥å…·ï¼Œå°‡é ç´„ã€è¨˜éŒ„ã€æ”¶æ¬¾æµç¨‹ä¸€æ°£å‘µæˆã€‚\n\n3. ä½æˆæœ¬é«˜æ•ˆç‡ï¼š\nç›¸æ¯”è˜è«‹çœŸäººåŠ©ç†ï¼Œè‡ªå‹•åŒ–ç³»çµ±çš„é‹è¡Œæˆæœ¬æ¥µä½ï¼Œä¸”ä¸æœƒæœ‰æƒ…ç·’æ³¢å‹•æˆ–è«‹å‡å•é¡Œï¼Œæ˜¯å¾®å‹å‰µæ¥­è€…çš„æœ€ä½³å¤¥ä¼´ã€‚" },
  { id: 2, sourceType: 'news', source: "Medium - Automation Hacks", title: "å¦‚ä½•ä½¿ç”¨ n8n ä¸²æ¥ Google Calendarï¼Ÿ", summary: "ä¸éœ€è¦å¯«ç¨‹å¼ï¼Œé€é Webhook å°±èƒ½å¯¦ç¾ LINE é ç´„è‡ªå‹•å¯«å…¥è¡Œäº‹æ›†...", date: "2025-11-12", tags: ["æ•™å­¸", "n8n"], content: "è¨±å¤šè‡ªç”±æ¥æ¡ˆè€…éƒ½é¢è‡¨è‘—é ç´„ç®¡ç†çš„å›°æ“¾ã€‚æœ¬æ–‡å°‡æ‰‹æŠŠæ‰‹æ•™ä½ å¦‚ä½•ä½¿ç”¨ n8n çš„ Google Calendar ç¯€é»ã€‚\n\næ­¥é©Ÿä¸€ï¼šç²å– API æ¬Šé™\né¦–å…ˆï¼Œä½ éœ€è¦åˆ° Google Cloud Platform ç”³è«‹ Calendar API çš„æ¬Šé™ï¼Œä¸¦ç²å– OAuth Client IDã€‚\n\næ­¥é©ŸäºŒï¼šè¨­å®š Webhook\nåœ¨ n8n ä¸­å»ºç«‹ä¸€å€‹ Webhook ç¯€é»ï¼Œç”¨ä¾†æ¥æ”¶ä¾†è‡ª LINE çš„é ç´„è«‹æ±‚è³‡æ–™ã€‚\n\næ­¥é©Ÿä¸‰ï¼šè³‡æ–™å¯«å…¥\nå°‡æ¥æ”¶åˆ°çš„æ—¥æœŸèˆ‡æ™‚é–“ï¼Œé€é Google Calendar ç¯€é»å¯«å…¥ä½ çš„è¡Œäº‹æ›†ã€‚é€™æ¨£ä¸€ä¾†ï¼Œç•¶å®¢æˆ¶åœ¨ LINE ä¸Šç¢ºèªé ç´„æ™‚ï¼Œä½ çš„è¡Œäº‹æ›†å°±æœƒè‡ªå‹•æ›´æ–°äº†ï¼" }
];

const RECOMMENDED_PRODUCTS = [
  { id: 1, name: "Notion å°ˆæ¡ˆç®¡ç†æ¨¡çµ„", price: 3000, img: "https://upload.wikimedia.org/wikipedia/commons/4/45/Notion_app_logo.png", desc: "è‡ªå‹•åŒæ­¥å®¢æˆ¶è³‡æ–™èˆ‡é€²åº¦" },
  { id: 2, name: "LINE å®˜æ–¹å¸³è™Ÿé€²éšç‰ˆ", price: 5000, img: "https://upload.wikimedia.org/wikipedia/commons/4/41/LINE_logo.svg", desc: "åŒ…å«åœ–æ–‡é¸å–®èˆ‡åˆ†çœ¾æ¨™ç±¤" },
  { id: 3, name: "IG è²¼æ–‡è‡ªå‹•ç”Ÿæˆå™¨", price: 4500, img: "https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png", desc: "ä¸€éµç”¢å‡ºé«˜è³ªæ„Ÿè²¼æ–‡" }
];

// --- Main Component ---

export default function ZuZuDashboard() {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [messages, setMessages] = useState(INITIAL_MESSAGES);
  const [selectedMsgId, setSelectedMsgId] = useState(101);
  const [notification, setNotification] = useState(null);
  
  // Inbox State
  const [aiInstruction, setAiInstruction] = useState("");
  const [isRegenerating, setIsRegenerating] = useState(false);
  const [manualInput, setManualInput] = useState("");
  const [isPolishing, setIsPolishing] = useState(false);
  const [searchQuery, setSearchQuery] = useState("");

  // CRM State & Filters
  const [clients, setClients] = useState(CLIENTS_DB);
  const [showClientModal, setShowClientModal] = useState(null);
  const [isEditingClient, setIsEditingClient] = useState(false);
  const [editingClientData, setEditingClientData] = useState({});
  const [crmStatusFilter, setCrmStatusFilter] = useState('all');
  const [crmTagFilter, setCrmTagFilter] = useState('all');
  const [crmSort, setCrmSort] = useState('recent');

  // Calendar State
  const [calendarView, setCalendarView] = useState('week');

  // Orders State & Filters
  const [orderFilterStatus, setOrderFilterStatus] = useState('all');
  const [orderFilterIndustry, setOrderFilterIndustry] = useState('all');
  const [orderFilterDate, setOrderFilterDate] = useState('all');

  // Finance State & Filters
  const [financeFilterStatus, setFinanceFilterStatus] = useState('all');
  const [financeFilterDate, setFinanceFilterDate] = useState('all');

  // Marketing State (Refactored)
  const [marketingSubTab, setMarketingSubTab] = useState('messages'); // messages, copywriting, ads, influencers
  const [marketingSource, setMarketingSource] = useState('all'); 
  const [marketingStep, setMarketingStep] = useState('crawler'); 
  const [generatedPost, setGeneratedPost] = useState("");
  const [inspirationInput, setInspirationInput] = useState("");
  const [showArticleModal, setShowArticleModal] = useState(null);
  const [marketingCategory, setMarketingCategory] = useState('trends'); // For copywriting subtab

  // Marketing - Broadcast
  const [broadcastTag, setBroadcastTag] = useState("all");
  const [broadcastMsg, setBroadcastMsg] = useState("");
  const [isBroadcasting, setIsBroadcasting] = useState(false);

  // Analysis State
  const [showReengagementModal, setShowReengagementModal] = useState(null);
  const [generatedReengagementMsg, setGeneratedReengagementMsg] = useState("");

  // Owner Setup Survey State
  const [ownerConfig, setOwnerConfig] = useState({
    services: "",
    rules: "",
    tone: "",
    links: "",
    qa_supplement: "",
    service_intro: "",
    notes: "",
    isSubmitted: false
  });
  const [isAnalyzingImage, setIsAnalyzingImage] = useState(false);
  const [imageAnalysisStep, setImageAnalysisStep] = useState("");
  const [isAnalyzingChat, setIsAnalyzingChat] = useState(false);

  // Onboarding & Integrations
  const [onboardingStep, setOnboardingStep] = useState(1);
  const [showOnboarding, setShowOnboarding] = useState(true);

  // Settings Modal
  const [showSettingsModal, setShowSettingsModal] = useState(false);

  const textareaRef = useRef(null);
  const chatEndRef = useRef(null);
  const inputRef = useRef(null); 
  const selectedMsg = messages.find(m => m.id === selectedMsgId);

  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [selectedMsg?.history]);

  // --- Actions ---

  const showNotification = (text) => {
    setNotification(text);
    setTimeout(() => setNotification(null), 3000);
  };

  const handleRefineDraft = async (id) => {
    if (!aiInstruction.trim()) return;
    setIsRegenerating(true);
    const msg = messages.find(m => m.id === id);
    const originalDraft = getCurrentDraft(msg);
    const prompt = `ä½ æ˜¯å¾®å‹ä¼æ¥­ä¸»çš„ AI åŠ©ç†ã€‚è«‹æ ¹æ“šä»¥ä¸‹æŒ‡ç¤ºé‡å¯«é€™æ®µè‰ç¨¿ï¼šæŒ‡ç¤ºã€Œ${aiInstruction}ã€ã€‚åŸè‰ç¨¿ï¼šã€Œ${originalDraft}ã€ã€‚è«‹ä¿æŒèªæ°£${ownerConfig.tone || 'è¦ªåˆ‡å°ˆæ¥­'}ã€‚ç›´æ¥è¼¸å‡ºé‡å¯«å¾Œçš„å…§å®¹ï¼Œä¸è¦æœ‰å‰è¨€ã€‚`;
    const newDraft = await callGemini(prompt);
    setMessages(prev => prev.map(msg => {
      if (msg.id === id) {
        return { ...msg, aiDraft: newDraft, aiDraftIndex: -1 };
      }
      return msg;
    }));
    setAiInstruction("");
    setIsRegenerating(false);
    showNotification("AI å·²æ ¹æ“šæŒ‡ä»¤é‡æ–°æ½¤é£¾è‰ç¨¿ï¼âœ¨");
  };

  const handleGenerateManualInput = async () => {
    setIsPolishing(true);
    const historyContext = selectedMsg.history.slice(-3).map(h => `${h.sender}: ${h.text}`).join("\n");
    const userInput = manualInput.trim();
    const prompt = `
      ä½ æ˜¯å®¢æœ AI åŠ©ç†ã€‚è«‹æ ¹æ“šä»¥ä¸‹å°è©±ç´€éŒ„èˆ‡ä½¿ç”¨è€…è¼¸å…¥ï¼Œç”Ÿæˆä¸€æ®µå®Œæ•´ã€ç¦®è²Œçš„å›è¦†ã€‚
      [å°è©±ç´€éŒ„]
      ${historyContext}
      [ä½¿ç”¨è€…è¼¸å…¥/é—œéµå­—]
      ${userInput || "(ç„¡è¼¸å…¥ï¼Œè«‹æ ¹æ“šä¸Šæ–‡ç”Ÿæˆåˆé©çš„å¾ŒçºŒå›æ‡‰)"}
      [æŒ‡ä»¤]
      å¦‚æœä½¿ç”¨è€…è¼¸å…¥äº†å…§å®¹ï¼Œè«‹å°‡å…¶å»¶å±•ç‚ºå®Œæ•´èªå¥ã€‚
      å¦‚æœä½¿ç”¨è€…æœªè¼¸å…¥ï¼Œè«‹æ ¹æ“šå°è©±ç´€éŒ„ç”Ÿæˆä¸€æ®µè²¼å¿ƒçš„é—œæ‡·æˆ–æœå‹™æ¨å»£ã€‚
      èªæ°£ï¼š${ownerConfig.tone || 'è¦ªåˆ‡ã€å°ˆæ¥­'}ã€‚
      è«‹ç›´æ¥è¼¸å‡ºå›è¦†å…§å®¹ï¼Œä¸è¦æœ‰ä»»ä½•èªªæ˜ã€‚
    `;
    const suggestion = await callGemini(prompt);
    setManualInput(suggestion);
    // Auto Resize after AI generation
    setTimeout(() => {
        if(inputRef.current) {
            inputRef.current.style.height = 'auto';
            inputRef.current.style.height = `${Math.min(inputRef.current.scrollHeight, 150)}px`;
        }
    }, 100);
    setIsPolishing(false);
    showNotification("AI å·²ç”Ÿæˆå»ºè­°è¨Šæ¯ï¼");
  };

  const handleSendMessage = (id) => {
    const msgToSend = getCurrentDraft(messages.find(m => m.id === id));
    const now = new Date();
    const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    setMessages(prev => prev.map(msg => {
      if (msg.id === id) {
        const isAppointment = msgToSend.includes("ç¢ºèª") || msgToSend.includes("é ç´„");
        return { 
          ...msg, 
          status: 'replied',
          lastMessage: `You: ${msgToSend.substring(0, 20)}...`, 
          history: [
              ...msg.history, 
              { sender: 'ai', text: msgToSend, time: timeString },
              ...(isAppointment ? [{ type: 'system', text: 'é ç´„å·²ç¢ºèª', showCalendarBtn: true }] : [])
          ]
        };
      }
      return msg;
    }));
    showNotification(`è¨Šæ¯å·²å‚³é€è‡³ ${messages.find(m => m.id === id).platform} âœ…`);
  };

  const handleAddToCalendar = () => {
      showNotification("å·²é–‹å•Ÿ Google Calendar ä¸¦åŠ å…¥è¡Œç¨‹ ğŸ“…");
  };

  const handleManualSend = (id) => {
    if (!manualInput.trim()) return;
    const now = new Date();
    const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    setMessages(prev => prev.map(msg => {
        if (msg.id === id) {
            const isAppointment = manualInput.includes("ç¢ºèª") || manualInput.includes("é ç´„") || manualInput.includes("æ²’å•é¡Œ");
            return {
                ...msg,
                lastMessage: `You: ${manualInput.substring(0, 20)}...`,
                history: [
                    ...msg.history, 
                    { sender: 'ai', text: manualInput, time: timeString },
                    ...(isAppointment ? [{ type: 'system', text: 'é ç´„å·²ç¢ºèª', showCalendarBtn: true }] : [])
                ]
            };
        }
        return msg;
    }));
    setManualInput("");
    if(inputRef.current) inputRef.current.style.height = 'auto'; // Reset height
  };

  const handleDraftEdit = (id, newText) => {
    setMessages(prev => prev.map(msg => {
      if (msg.id === id) {
        return { ...msg, aiDraft: newText, aiDraftIndex: -1 };
      }
      return msg;
    }));
  };

  const handleRecommendProduct = (id) => {
    const recommendationMsg = `æ‚¨å¥½ï¼æ ¹æ“šæ‚¨çš„éœ€æ±‚ï¼ˆè‡ªå‹•åŒ–ç®¡ç†ã€æå‡æ•ˆç‡ï¼‰ï¼Œæ¨è–¦æ‚¨ä»¥ä¸‹å¹¾æ¬¾æˆ‘å€‘çš„ç†±é–€æ¨¡çµ„ï¼Œèƒ½æœ‰æ•ˆæ¸›å°‘è¡Œæ”¿è² æ“”å–”ï¼âœ¨\n\n` + 
      RECOMMENDED_PRODUCTS.map(p => `â€¢ ${p.name} - NT$${p.price}`).join('\n');
    setMessages(prev => prev.map(msg => {
        if (msg.id === id) {
            return {
                ...msg,
                aiDraft: recommendationMsg,
                aiDraftIndex: -1 
            };
        }
        return msg;
    }));
    showNotification("AI å·²ç”Ÿæˆæœå‹™æ¨è–¦æ–¹æ¡ˆï¼ğŸ");
  };

  const handleJumpToChat = (clientName) => {
    const existingMsg = messages.find(m => m.client === clientName);
    setShowClientModal(null); 
    if (existingMsg) {
      setSelectedMsgId(existingMsg.id);
      setActiveTab('inbox');
      showNotification(`å·²è·³è½‰è‡³èˆ‡ ${clientName} çš„å°è©± ğŸ’¬`);
    } else {
      showNotification(`æš«ç„¡ ${clientName} çš„è¿‘æœŸå°è©±ç´€éŒ„`);
    }
  };

  const handleViewClientDetail = (client) => {
    if (client) {
      setEditingClientData({ ...client });
      setIsEditingClient(false);
      setShowClientModal(client);
    } else {
      showNotification("æŸ¥ç„¡æ­¤å®¢æˆ¶è³‡æ–™");
    }
  };

  const handleSaveClientData = () => {
    setClients(prev => prev.map(c => c.id === editingClientData.id ? editingClientData : c));
    setShowClientModal(editingClientData); 
    setIsEditingClient(false);
    showNotification("å®¢æˆ¶è³‡æ–™æ›´æ–°æˆåŠŸï¼ğŸ’¾");
  };

  const handleGeneratePost = async (item, type) => {
    setMarketingStep('loading');
    let prompt = "";
    if (type === 'trends') {
      prompt = `è«‹ç‚ºé€™ç¯‡ç”¢æ¥­æ–°èæ’°å¯«ä¸€ç¯‡å¸å¼•äººçš„ç¤¾ç¾¤è²¼æ–‡ (Instagram/Threads)ã€‚æ–°èæ¨™é¡Œï¼š${item.title}ã€‚æ‘˜è¦ï¼š${item.summary}ã€‚é¢¨æ ¼ï¼šå°ˆæ¥­ã€æœ‰æ´è¦‹ã€‚è«‹åŠ å…¥è¡¨æƒ…ç¬¦è™Ÿèˆ‡ Hashtagsã€‚`;
    } else if (type === 'inspiration') {
      prompt = `è«‹æ ¹æ“šé€™æ®µå‰µæ¥­å°æ•…äº‹ï¼Œæ’°å¯«ä¸€ç¯‡å¼•èµ·å…±é³´çš„ç¤¾ç¾¤è²¼æ–‡ï¼š${inspirationInput}ã€‚é¢¨æ ¼ï¼šæ„Ÿæ€§ã€å•Ÿç™¼æ€§ã€‚è«‹åŠ å…¥è¡¨æƒ…ç¬¦è™Ÿèˆ‡ Hashtagsã€‚`;
    } else if (type === 'success') {
      prompt = `è«‹æ’°å¯«ä¸€ç¯‡å®¢æˆ¶æˆåŠŸæ¡ˆä¾‹è²¼æ–‡ã€‚å®¢æˆ¶ï¼š${item.company} (${item.name})ã€‚ç—›é»ï¼š${item.notes}ã€‚è§£æ±ºæ–¹æ¡ˆï¼š${item.plan} æ–¹æ¡ˆã€‚é¢¨æ ¼ï¼šæ…¶ç¥ã€å°ˆæ¥­è¦‹è­‰ã€‚`;
    } else if (type === 'features') {
      prompt = `è«‹æ’°å¯«ä¸€ç¯‡æ¨å»£åŠŸèƒ½çš„è²¼æ–‡ã€‚åŠŸèƒ½åç¨±ï¼š${item.title}ã€‚æè¿°ï¼š${item.desc}ã€‚è§£æ±ºç—›é»ï¼š${item.painPoint}ã€‚é¢¨æ ¼ï¼šéŠ·å”®å°å‘ã€å¼·èª¿æ•ˆç‡ã€‚`;
    }
    const content = await callGemini(prompt);
    setGeneratedPost(content);
    setMarketingStep('editor');
  };

  const handlePublishPost = () => {
    setMarketingStep('done');
    showNotification("è²¼æ–‡å·²æ’ç¨‹ç™¼ä½ˆè‡³ Instagram èˆ‡ Threads ğŸš€");
    setTimeout(() => {
        setMarketingStep('crawler');
        setInspirationInput("");
    }, 2000);
  };

  const handleBroadcast = () => {
      setIsBroadcasting(true);
      const targetClients = broadcastTag === 'all' 
          ? clients 
          : clients.filter(c => c.tags.includes(broadcastTag));
      
      const count = targetClients.length;
      
      setTimeout(() => {
          // UPDATE MESSAGE HISTORY TO SIMULATE SENDING
          const now = new Date();
          const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

          setMessages(prevMessages => {
            const updatedMessages = [...prevMessages];
            targetClients.forEach(client => {
                const msgIndex = updatedMessages.findIndex(m => m.client === client.name);
                if (msgIndex !== -1) {
                    updatedMessages[msgIndex] = {
                        ...updatedMessages[msgIndex],
                        status: 'replied',
                        lastMessage: `You: ${broadcastMsg.substring(0, 15)}...`,
                        history: [
                            ...updatedMessages[msgIndex].history,
                            { sender: 'ai', text: broadcastMsg, time: timeString }
                        ]
                    };
                }
            });
            return updatedMessages;
          });

          setIsBroadcasting(false);
          setBroadcastMsg("");
          showNotification(`æˆåŠŸç™¼é€è¨Šæ¯çµ¦ ${count} ä½å®¢æˆ¶ï¼å·²æ›´æ–°æ”¶ä»¶åŒ£ç´€éŒ„ ğŸ“¢`);
      }, 1500);
  };

  const handleImageUpload = (e) => {
    setIsAnalyzingImage(true);
    setImageAnalysisStep("æƒæåœ–ç‰‡ä¸­...");
    setTimeout(() => setImageAnalysisStep("é€²è¡Œ OCR æ–‡å­—æå–..."), 1000);
    setTimeout(() => setImageAnalysisStep("çµæ§‹åŒ–æ•¸æ“šè½‰æ›..."), 2000);
    setTimeout(() => {
      setIsAnalyzingImage(false);
      setImageAnalysisStep("");
      setOwnerConfig(prev => ({
        ...prev,
        services: "Fish Nail Studio\n--- æ‰‹éƒ¨å¥ç”²å‹å‡è†  ---\nå–®è‰²: NT.1000\nè²“çœ¼: NT.1200\næ¼¸å±¤/ç’€ç’¨: NT.1300\næ³•å¼: NT.1400\n(è¶³éƒ¨åƒ¹ä½ +NT.200)\nå‡è† å»¶ç”²: NT.150/æŒ‡\n\n--- å¸ç”² ---\næœ¬åº—ä½œå“ å–®ç´”å¸ç”²: NT.300 / å¸ç”²é‡åš: NT.300\nä»–åº—ä½œå“ å–®ç´”å¸ç”²: NT.500 / å¸ç”²é‡åš: NT.400\n(ä¸å¯å¸/æ°´æ™¶ä¸€å¾‹NT.600)\n(ç´”å¸ç”²çš†å«æ‹‹å…‰/ç¡¬ç”²æ²¹)\n(è¶³éƒ¨åƒ¹ä½+NT.100)\n\n--- ä¿é¤Š ---\nåŸºç¤ä¿é¤Šæ‰‹/è¶³: NT.500/800\nè¶³éƒ¨ç¡¬ç¹­ä¿é¤Š: NT.1100\nè¶³éƒ¨æ°´å«©ä¿é¤Š: NT.1500\nè¶³éƒ¨æ·±å±¤ä¿é¤Š: NT.2200\nè¶³éƒ¨åŠ è³¼å–®è‰²å‡è† : NT.400\n\n--- ç¾ç« ---\nå–®æ ¹å¼: NT.6/æ ¹\nå¤šæ ¹å¼: NT.5/æ ¹\n(æœ€å°‘300æ ¹)"
      }));
      showNotification("AI è¾¨è­˜å®Œæˆï¼å·²è‡ªå‹•å°‡åœ–ç‰‡è½‰ç‚ºåƒ¹ç›®è¡¨ã€‚âœ¨");
    }, 3000);
  };

  const handleChatUpload = (e) => {
      setIsAnalyzingChat(true);
      setTimeout(() => {
          setIsAnalyzingChat(false);
          setOwnerConfig(prev => ({
              ...prev,
              tone: "è¦ªåˆ‡ã€æ´»æ½‘ã€ç¿’æ…£ç”¨ã€Œï½ã€çµå°¾ã€å¸¸ç”¨ ğŸ˜Š ç¬¦è™Ÿ"
          }));
          showNotification("AI å·²åˆ†æå®Œç•¢ï¼Œèª¿æ•´äº†å›è¦†èªæ°£è¨­å®šï¼ğŸ—£ï¸");
      }, 1500);
  };

  const handleSaveConfig = () => {
    setOwnerConfig(prev => ({ ...prev, isSubmitted: true }));
    showNotification("AI çŸ¥è­˜åº«å·²æ›´æ–°ï¼åŠ©æ‰‹å°‡ä¾æ“šæ–°è¦å‰‡å›æ‡‰å®¢æˆ¶ã€‚");
  };

  const handleGenerateReengagement = async (client) => {
      const prompt = `è«‹ç‚ºé€™ä½å®¢æˆ¶æ’°å¯«ä¸€å‰‡å–šé†’è¨Šæ¯ (Re-engagement Message)ã€‚å®¢æˆ¶å§“åï¼š${client.name}ã€‚ä¸Šæ¬¡äº’å‹•ï¼š${client.lastContact}ã€‚ç”¢æ¥­ï¼š${client.industry}ã€‚æ¨å»£é‡é»ï¼šæˆ‘å€‘æ–°æ¨å‡ºäº†ã€Œè‡ªå‹•åŒ–ç™¼ç¥¨é–‹ç«‹ã€åŠŸèƒ½ã€‚èªæ°£ï¼š${ownerConfig.tone || 'è¦ªåˆ‡ã€ä¸æ‰“æ“¾'}ã€‚ç›´æ¥è¼¸å‡ºè¨Šæ¯å…§å®¹ã€‚`;
      const msg = await callGemini(prompt);
      setGeneratedReengagementMsg(msg);
      setShowReengagementModal(client);
  };

  const getCurrentDraft = (msg) => {
    if (typeof msg.aiDraft === 'string') return msg.aiDraft; 
    const variants = AI_DRAFT_VARIANTS[msg.id];
    if (variants && variants.length > 0) return variants[msg.aiDraftIndex];
    return "ï¼ˆAI æ­£åœ¨æ€è€ƒä¸­...ï¼‰";
  };

  const handleManualEditClick = () => {
    if (textareaRef.current) {
        textareaRef.current.focus();
    }
  };

  // Textarea Auto Resize
  const handleInputResize = (e) => {
    setManualInput(e.target.value);
    e.target.style.height = 'auto';
    e.target.style.height = `${Math.min(e.target.scrollHeight, 150)}px`;
  };

  // Filtered Lists
  const filteredMessages = messages.filter(m => 
    m.client.toLowerCase().includes(searchQuery.toLowerCase()) || 
    m.lastMessage.toLowerCase().includes(searchQuery.toLowerCase())
  );
  
  const filteredArticles = CRAWLED_ARTICLES.filter(article => {
      if (marketingSource === 'all') return true;
      return article.sourceType === marketingSource;
  });

  const filteredOrders = ALL_DATA.filter(apt => {
    const matchStatus = orderFilterStatus === 'all' || (orderFilterStatus === 'paid' ? apt.payment === 'paid' : apt.payment === 'unpaid');
    const matchIndustry = orderFilterIndustry === 'all' || apt.industry === orderFilterIndustry;
    const matchDate = orderFilterDate === 'all' || apt.date === orderFilterDate;
    return matchStatus && matchIndustry && matchDate;
  });

  const filteredFinanceData = ALL_DATA.filter(apt => {
    const isNov = apt.date.includes("2025-11");
    const matchDate = financeFilterDate === 'all' || (financeFilterDate === 'current' && isNov);
    const matchStatus = financeFilterStatus === 'all' || (financeFilterStatus === 'paid' ? apt.payment === 'paid' : apt.payment === 'unpaid');
    return matchDate && matchStatus && apt.amount > 0;
  });

  const filteredClients = clients.filter(client => {
    const matchStatus = crmStatusFilter === 'all' || client.status === crmStatusFilter;
    const matchTag = crmTagFilter === 'all' || client.tags.includes(crmTagFilter);
    return matchStatus && matchTag;
  }).sort((a, b) => {
    if (crmSort === 'recent') return new Date(b.lastContact) - new Date(a.lastContact);
    if (crmSort === 'oldest') return new Date(a.lastContact) - new Date(b.lastContact);
    return 0;
  });

  const uniqueIndustries = [...new Set(ALL_DATA.map(a => a.industry))];
  const uniqueDates = [...new Set(ALL_DATA.map(a => a.date))];
  const uniqueClientTags = [...new Set(clients.flatMap(c => c.tags))];

  return (
    <div className="min-h-screen bg-[#FDFBF7] font-sans flex text-slate-800 selection:bg-orange-100">
      
      {/* Sidebar for Desktop */}
      <aside className="w-64 bg-white border-r border-slate-100 hidden md:flex flex-col fixed h-full z-10">
        <div className="p-6 flex items-center gap-3">
          <ZuZuLogo size={40} />
          <div>
            <h1 className="font-bold text-xl tracking-tight text-slate-800">ZuZu Buddy</h1>
          </div>
        </div>

        <nav className="flex-1 px-4 py-4 space-y-1">
          <SidebarItem icon={LayoutDashboard} label="ç¸½è¦½å„€è¡¨æ¿" active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} />
          <SidebarItem icon={MessageSquare} label="æ™ºæ…§æ”¶ä»¶åŒ£" active={activeTab === 'inbox'} onClick={() => setActiveTab('inbox')} alertCount={messages.filter(m=>m.status==='pending_review').length} />
          <SidebarItem icon={CalendarIcon} label="é ç´„è¡Œäº‹æ›†" active={activeTab === 'calendar'} onClick={() => setActiveTab('calendar')} />
          <SidebarItem icon={ClipboardList} label="è¨‚å–®ç®¡ç†" active={activeTab === 'orders'} onClick={() => setActiveTab('orders')} />
          <SidebarItem icon={DollarSign} label="é‡‘æµèˆ‡ç‡Ÿæ”¶åˆ†æ" active={activeTab === 'finance'} onClick={() => setActiveTab('finance')} />
          <SidebarItem icon={Megaphone} label="è¡ŒéŠ·åŠ©æ‰‹" active={activeTab === 'marketing'} onClick={() => setActiveTab('marketing')} />
          <SidebarItem icon={BrainCircuit} label="æ™ºèƒ½å•†å‹™åˆ†æ" active={activeTab === 'analysis'} onClick={() => setActiveTab('analysis')} />
          <SidebarItem icon={Users} label="å®¢æˆ¶åå–®" active={activeTab === 'crm'} onClick={() => setActiveTab('crm')} />
          <div className="my-2 border-t border-slate-100"></div>
          <SidebarItem icon={Plug} label="æ•´åˆä¸­å¿ƒ" active={activeTab === 'integrations'} onClick={() => setActiveTab('integrations')} />
          <SidebarItem icon={Settings} label="AI è¨­å®šå•å·" active={activeTab === 'owner_setup'} onClick={() => setActiveTab('owner_setup')} />
        </nav>

        <div className="p-4 border-t border-slate-100">
          <div 
            onClick={() => setShowSettingsModal(true)}
            className="bg-slate-50 rounded-xl p-4 flex items-center gap-3 cursor-pointer hover:bg-slate-100 transition-colors"
          >
            <div className="w-10 h-10 rounded-full bg-slate-200 overflow-hidden">
               <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Annie" alt="User" />
            </div>
            <div className="flex-1 min-w-0">
              <p className="text-sm font-bold text-slate-700 truncate">YUJUN</p>
              <p className="text-xs text-slate-400 truncate">Pro æ–¹æ¡ˆ</p>
            </div>
          </div>
        </div>
      </aside>

      {/* Mobile Bottom Nav */}
      <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around p-2 z-50 safe-area-bottom">
        <button onClick={() => setActiveTab('dashboard')} className={`p-2 rounded-lg flex flex-col items-center ${activeTab === 'dashboard' ? 'text-orange-600' : 'text-slate-400'}`}>
            <Home className="w-6 h-6" />
            <span className="text-[10px] font-bold mt-1">é¦–é </span>
        </button>
        <button onClick={() => setActiveTab('inbox')} className={`p-2 rounded-lg flex flex-col items-center ${activeTab === 'inbox' ? 'text-orange-600' : 'text-slate-400'}`}>
            <div className="relative">
                <MessageSquare className="w-6 h-6" />
                {messages.filter(m=>m.status==='pending_review').length > 0 && <div className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></div>}
            </div>
            <span className="text-[10px] font-bold mt-1">æ”¶ä»¶åŒ£</span>
        </button>
        <button onClick={() => setActiveTab('calendar')} className={`p-2 rounded-lg flex flex-col items-center ${activeTab === 'calendar' ? 'text-orange-600' : 'text-slate-400'}`}>
            <CalendarIcon className="w-6 h-6" />
            <span className="text-[10px] font-bold mt-1">è¡Œäº‹æ›†</span>
        </button>
        <button onClick={() => setActiveTab('orders')} className={`p-2 rounded-lg flex flex-col items-center ${activeTab === 'orders' ? 'text-orange-600' : 'text-slate-400'}`}>
            <ClipboardList className="w-6 h-6" />
            <span className="text-[10px] font-bold mt-1">è¨‚å–®</span>
        </button>
      </div>

      {/* Main Content */}
      <main className="flex-1 md:ml-64 p-4 md:p-8 overflow-y-auto h-screen pb-24 md:pb-8">
        
        {/* Mobile Header */}
        <div className="md:hidden flex items-center justify-between mb-6">
           <div className="flex items-center gap-2">
             <ZuZuLogo size={32} />
             <div className="font-bold text-xl text-slate-800">ZuZu Buddy</div>
           </div>
           <Bell className="w-5 h-5 text-slate-600" />
        </div>

        {/* --- DASHBOARD TAB --- */}
        {activeTab === 'dashboard' && (
          <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
             
             {/* Onboarding Widget */}
             {showOnboarding && (
                <div className="bg-white rounded-xl border border-slate-200 p-4 shadow-sm flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                    <div className="flex items-center gap-3">
                        <div className="p-2 bg-orange-100 text-orange-600 rounded-full">
                            <CheckSquare className="w-5 h-5" />
                        </div>
                        <div>
                            <h3 className="font-bold text-slate-800">æ­¡è¿ä½¿ç”¨ ZuZu Buddyï¼</h3>
                            <p className="text-sm text-slate-500">å®Œæˆæ–°æ‰‹ä»»å‹™ï¼Œè®“ AI åŠ©æ‰‹é–‹å§‹ç‚ºæ‚¨å·¥ä½œã€‚</p>
                        </div>
                    </div>
                    <div className="w-full md:w-auto flex flex-col md:flex-row items-center gap-4">
                        <div className="w-full md:w-48 h-2 bg-slate-100 rounded-full overflow-hidden">
                            <div className="h-full bg-orange-500 w-1/4"></div>
                        </div>
                        <span className="text-xs font-bold text-slate-400">é€²åº¦ 1/4</span>
                        <button onClick={() => setShowOnboarding(false)} className="text-slate-400 hover:text-slate-600">
                            <X className="w-4 h-4" />
                        </button>
                    </div>
                </div>
             )}

             {/* UPDATED: Smaller Morning Greeting Section */}
             <div className="bg-orange-500 rounded-2xl p-5 text-white flex justify-between items-center shadow-lg shadow-orange-200 relative overflow-hidden">
                <div className="relative z-10 flex items-center gap-4">
                   <div className="p-3 bg-white/20 rounded-full">
                      <Clock className="w-6 h-6 text-white" />
                   </div>
                   <div>
                       <h2 className="text-xl font-bold mb-1">æ—©å®‰ï¼ŒYUJUNï¼â˜€ï¸</h2>
                       <p className="opacity-90 text-sm">ZuZu ä»Šå¤©æ””æˆªäº† {messages.filter(m => m.status === 'replied').length} ç­†é ç´„ï¼Œçœä¸‹ç´„ 1.5 å°æ™‚ã€‚</p>
                   </div>
                </div>
                {/* Removed large Clock icon to save space */}
             </div>

             <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <StatCard title="å¾…å›è¦†è¨Šæ¯" value={messages.filter(m=>m.status==='pending_review').length} icon={MessageSquare} color="bg-red-100 text-red-600" />
                <StatCard title="æœ¬é€±é ç´„" value={ALL_DATA.length} icon={CalendarIcon} color="bg-blue-100 text-blue-600" />
                <StatCard title="æœ¬æœˆç‡Ÿæ”¶é ä¼°" value="NT$ 125k" icon={TrendingUp} color="bg-green-100 text-green-600" />
             </div>

             <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                {/* Left Column: Urgent Tasks */}
                <div className="lg:col-span-2 space-y-6">
                  <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden h-full">
                    <div className="p-6 border-b border-slate-100 flex justify-between items-center">
                      <h3 className="font-bold text-slate-800 flex items-center gap-2">
                        <div className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                        æœ€æ–°å¾…è¾¦äº‹é … (æœªå›è¦†)
                      </h3>
                      <button onClick={() => setActiveTab('inbox')} className="text-sm text-orange-600 font-bold hover:underline">è™•ç†æ‰€æœ‰</button>
                    </div>
                    <div className="divide-y divide-slate-50">
                      {messages.filter(m => m.status === 'pending_review').length > 0 ? (
                        messages.filter(m => m.status === 'pending_review').slice(0, 3).map(msg => (
                          <div key={msg.id} onClick={() => {setActiveTab('inbox'); setSelectedMsgId(msg.id);}} className="p-4 hover:bg-slate-50 cursor-pointer flex items-center gap-4 transition-colors">
                            <img src={msg.avatar} className="w-10 h-10 rounded-full" alt="" />
                            <div className="flex-1 min-w-0">
                              <div className="flex justify-between items-center mb-1">
                                <span className="font-bold text-slate-800 text-sm">{msg.client}</span>
                                <span className="text-xs text-slate-400">{msg.time}</span>
                              </div>
                              <p className="text-sm text-slate-500 truncate">{msg.lastMessage}</p>
                            </div>
                            <div className="px-3 py-1 bg-orange-100 text-orange-700 text-xs font-bold rounded-full">AI æ“¬ç¨¿å®Œæˆ</div>
                          </div>
                        ))
                      ) : (
                        <div className="p-8 text-center text-slate-400">
                          <CheckCircle className="w-12 h-12 mx-auto mb-2 opacity-20" />
                          <p>å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰å¾…è¾¦äº‹é … ğŸ‰</p>
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                {/* Right Column: Today's Agenda (Synced with CURRENT_DATE) */}
                <div className="space-y-6">
                  <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 h-full">
                    <div className="flex justify-between items-center mb-6">
                      <h3 className="font-bold text-slate-800 flex items-center gap-2">
                        <CalendarIcon className="w-4 h-4 text-slate-500" />
                        ä»Šæ—¥è¡Œç¨‹ ({CURRENT_DATE.slice(5)})
                      </h3>
                    </div>
                    <div className="space-y-4">
                      {ALL_DATA.filter(a => a.date === CURRENT_DATE).map((apt, index) => (
                        <div key={apt.id} className="relative pl-6 pb-2 last:pb-0">
                          <div className={`absolute left-0 top-1.5 w-4 h-4 rounded-full border-2 ${apt.status === 'upcoming' ? 'border-orange-500 bg-white' : 'border-slate-300 bg-slate-100'}`}></div>
                          <div className="bg-slate-50 rounded-xl p-3 border border-slate-100">
                             <div className="flex justify-between items-center mb-1">
                               <span className="font-bold text-slate-800 text-sm">{apt.time}</span>
                               <span className={`text-[10px] px-2 py-0.5 rounded font-bold ${apt.status === 'upcoming' ? 'bg-orange-100 text-orange-600' : 'bg-slate-200 text-slate-500'}`}>
                                 {apt.status === 'upcoming' ? 'å³å°‡é–‹å§‹' : 'å·²ç¢ºèª'}
                               </span>
                             </div>
                             <div className="text-sm font-medium text-slate-700">{apt.service}</div>
                             <div className="text-xs text-slate-500 mt-1">{apt.client} ({apt.industry})</div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
             </div>

             {/* AI Data Visualization Section (UPDATED) */}
             <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                   <h3 className="font-bold text-slate-800 flex items-center gap-2">
                      <BarChart2 className="w-5 h-5 text-purple-500" />
                      AI æ•ˆèƒ½æ´å¯Ÿ (è¿‘ 7 æ—¥)
                   </h3>
                   <div className="flex gap-4 text-sm">
                      <div className="flex flex-col items-center px-3 py-1 bg-slate-50 rounded-lg">
                         <span className="text-xs text-slate-400">ç¸½å°è©±æ•¸</span>
                         <span className="font-bold text-slate-800">342 å‰‡</span>
                      </div>
                      <div className="flex flex-col items-center px-3 py-1 bg-slate-50 rounded-lg">
                         <span className="text-xs text-slate-400">AI æ””æˆªç‡</span>
                         <span className="font-bold text-green-600">82%</span>
                      </div>
                   </div>
                </div>
                {/* Adjusted Bar Chart - Better Visuals */}
                <div className="flex items-end justify-between h-40 gap-4">
                   {[65, 80, 45, 90, 75, 60, 85].map((h, i) => (
                      <div key={i} className="flex-1 flex flex-col justify-end group relative h-full">
                         {/* Background Track */}
                         <div className="absolute bottom-0 w-full h-full bg-slate-100 rounded-md"></div>
                         
                         {/* Foreground Bar */}
                         <div 
                           className="relative w-full bg-gradient-to-t from-orange-400 to-orange-300 rounded-md hover:from-orange-500 hover:to-orange-400 transition-all duration-500 shadow-sm" 
                           style={{height: `${h}%`}}
                         >
                            {/* Floating Tooltip */}
                            <div className="opacity-0 group-hover:opacity-100 absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-xs py-1 px-2 rounded pointer-events-none transition-opacity whitespace-nowrap z-10">
                                {h}%
                            </div>
                         </div>
                         
                         <div className="text-xs text-center text-slate-400 mt-2 font-medium relative z-10">{['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'][i]}</div>
                      </div>
                   ))}
                </div>
             </div>
          </div>
        )}

        {/* --- INTEGRATIONS HUB --- */}
        {activeTab === 'integrations' && (
            <div className="space-y-6 animate-in fade-in duration-500">
                <h2 className="text-2xl font-bold text-slate-800">æ•´åˆä¸­å¿ƒ (Integrations)</h2>
                <p className="text-slate-500">é€£çµæ‚¨çš„å¤–éƒ¨å¸³è™Ÿï¼Œè®“ ZuZu è‡ªå‹•åŒ–è™•ç†æ‚¨çš„æ¥­å‹™ã€‚</p>
                
                {/* UPDATED: Added more integrations */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <IntegrationCard name="LINE å®˜æ–¹å¸³è™Ÿ" icon={MessageCircle} status="connected" color="text-green-500" desc="è‡ªå‹•æ¥æ”¶èˆ‡å›è¦†è¨Šæ¯" />
                    <IntegrationCard name="Google Calendar" icon={CalendarIcon} status="connected" color="text-blue-500" desc="é›™å‘åŒæ­¥è¡Œç¨‹" />
                    <IntegrationCard name="Instagram / FB" icon={Instagram} status="disconnected" color="text-pink-500" desc="è‡ªå‹•ç™¼å¸ƒè²¼æ–‡" />
                    <IntegrationCard name="Stripe é‡‘æµ" icon={CreditCard} status="connected" color="text-purple-500" desc="æ¥æ”¶ä»˜æ¬¾èˆ‡é–‹ç«‹ç™¼ç¥¨" />
                    <IntegrationCard name="Notion" icon={FileText} status="disconnected" color="text-slate-500" desc="åŒæ­¥ CRM å®¢æˆ¶è³‡æ–™" />
                    
                    {/* New Additions */}
                    <IntegrationCard name="Shopify / WooCommerce" icon={ShoppingCart} status="disconnected" color="text-green-600" desc="è¨‚å–®åŒæ­¥èˆ‡åº«å­˜ç®¡ç†" />
                    <IntegrationCard name="Zapier" icon={Workflow} status="disconnected" color="text-orange-500" desc="ä¸²æ¥ 5000+ ç¨®æ‡‰ç”¨ç¨‹å¼" />
                    <IntegrationCard name="Mailchimp" icon={MailIcon} status="disconnected" color="text-yellow-500" desc="é›»å­å ±è¡ŒéŠ·è‡ªå‹•åŒ–" />
                </div>
            </div>
        )}

        {/* --- SMART ANALYSIS TAB (Refactored) --- */}
        {activeTab === 'analysis' && (
            <div className="space-y-6 animate-in fade-in duration-500">
                <div className="bg-gradient-to-r from-indigo-900 to-purple-900 rounded-2xl p-8 text-white shadow-lg">
                   <div className="flex items-center gap-4">
                       <div className="p-3 bg-white/10 rounded-xl">
                           <BrainCircuit className="w-8 h-8 text-purple-300" />
                       </div>
                       <div>
                           <h2 className="text-2xl font-bold">æ™ºèƒ½å•†å‹™åˆ†æ</h2>
                           <p className="opacity-80">ZuZu æ ¹æ“šæ‚¨çš„ç‡Ÿé‹æ•¸æ“šï¼Œç‚ºæ‚¨åˆ†ææ½›åœ¨æ©Ÿæœƒèˆ‡é¢¨éšªã€‚</p>
                       </div>
                   </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* Hot Topics */}
                    <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-4">
                           <MessageCircle className="w-5 h-5 text-orange-500" />
                           å®¢æˆ¶ç†±é–€æå• TOP 3
                        </h3>
                        <div className="space-y-4">
                            {[
                                { q: "è«‹å•å¯ä»¥å¹«å¿™ä¸²æ¥ Notion å—ï¼Ÿ", count: 12, trend: "up" },
                                { q: "æ”¶è²»æ–¹å¼èˆ‡æ–¹æ¡ˆå·®ç•°ï¼Ÿ", count: 8, trend: "stable" },
                                { q: "LINE å®˜æ–¹å¸³è™Ÿéœ€è¦å‡ç´šå—ï¼Ÿ", count: 5, trend: "down" }
                            ].map((item, i) => (
                                <div key={i} className="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                    <div className="flex items-center gap-3">
                                        <div className="w-6 h-6 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center text-xs font-bold">{i+1}</div>
                                        <span className="text-sm font-medium text-slate-700">{item.q}</span>
                                    </div>
                                    <div className="text-xs font-bold text-slate-500">{item.count} æ¬¡è©¢å•</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* User Source Analysis */}
                    <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-4">
                           <Target className="w-5 h-5 text-blue-500" />
                           ç”¨æˆ¶ä¾†æºåˆ†æ
                        </h3>
                        <div className="flex items-center gap-8">
                            <div className="relative w-32 h-32 rounded-full border-8 border-slate-100" 
                                 style={{background: 'conic-gradient(#E1306C 0% 50%, #000000 50% 80%, #06C755 80% 100%)'}}>
                            </div>
                            <div className="space-y-3 text-sm">
                                <div className="flex items-center justify-between w-40">
                                    <span className="flex items-center gap-2"><div className="w-3 h-3 bg-[#E1306C] rounded-full"></div> Instagram</span>
                                    <span className="font-bold text-slate-700">50%</span>
                                </div>
                                <div className="flex items-center justify-between w-40">
                                    <span className="flex items-center gap-2"><div className="w-3 h-3 bg-black rounded-full"></div> Threads</span>
                                    <span className="font-bold text-slate-700">30%</span>
                                </div>
                                <div className="flex items-center justify-between w-40">
                                    <span className="flex items-center gap-2"><div className="w-3 h-3 bg-[#06C755] rounded-full"></div> LINE</span>
                                    <span className="font-bold text-slate-700">20%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* UPDATED: New Analysis Section - Peak Hours */}
                    <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-4">
                           <Clock className="w-5 h-5 text-purple-500" />
                           ç†±é–€é ç´„æ™‚æ®µåˆ†æ
                        </h3>
                        <div className="flex items-end gap-2 h-40 pt-4">
                           {[10, 15, 40, 60, 85, 50, 30, 20].map((h, i) => (
                             <div key={i} className="flex-1 flex flex-col items-center gap-2 group">
                                <div className="w-full bg-purple-100 rounded-t-lg relative hover:bg-purple-200 transition-all" style={{height: `${h}%`}}>
                                    <div className="opacity-0 group-hover:opacity-100 absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-xs py-1 px-2 rounded pointer-events-none whitespace-nowrap">
                                        {10+i}:00
                                    </div>
                                </div>
                                <span className="text-[10px] text-slate-400 font-bold">{10+i}é»</span>
                             </div>
                           ))}
                        </div>
                    </div>

                    {/* UPDATED: New Analysis Section - Revenue Contribution */}
                    <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-4">
                           <DollarSign className="w-5 h-5 text-green-500" />
                           æœå‹™ç‡Ÿæ”¶è²¢ç»ä½”æ¯”
                        </h3>
                        <div className="space-y-4">
                            {[
                                { name: "ç³»çµ±æ¶è¨­è«®è©¢", percent: 45, color: "bg-blue-500" },
                                { name: "Pro æ–¹æ¡ˆè¨‚é–±", percent: 35, color: "bg-purple-500" },
                                { name: "ç¾æ¥­è‡ªå‹•åŒ–åŒ…", percent: 20, color: "bg-pink-500" },
                            ].map((item, i) => (
                                <div key={i}>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="font-bold text-slate-700">{item.name}</span>
                                        <span className="text-slate-500">{item.percent}%</span>
                                    </div>
                                    <div className="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
                                        <div className={`h-full ${item.color}`} style={{width: `${item.percent}%`}}></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        )}

        {/* --- INBOX TAB --- */}
        {activeTab === 'inbox' && (
          <div className="h-[calc(100vh-8rem)] bg-white rounded-2xl border border-slate-200 flex overflow-hidden shadow-sm animate-in fade-in zoom-in-95 duration-300">
            {/* Inbox List */}
            <div className="w-1/3 border-r border-slate-100 flex flex-col">
              <div className="p-4 border-b border-slate-100 bg-slate-50">
                <div className="relative">
                  <Search className="w-4 h-4 absolute left-3 top-3 text-slate-400" />
                  <input 
                    type="text" 
                    placeholder="æœå°‹è¨Šæ¯..." 
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="w-full pl-9 pr-4 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500/20" 
                  />
                </div>
              </div>
              <div className="flex-1 overflow-y-auto">
                {filteredMessages.length > 0 ? filteredMessages.map((msg) => (
                  <div 
                    key={msg.id} 
                    onClick={() => setSelectedMsgId(msg.id)}
                    className={`p-4 hover:bg-orange-50 cursor-pointer transition-colors border-b border-slate-50 ${selectedMsgId === msg.id ? 'bg-orange-50 border-orange-100' : ''}`}
                  >
                    <div className="flex justify-between items-start mb-2">
                      <div className="font-bold text-slate-800 flex items-center gap-2 text-sm">
                        {msg.client}
                        {msg.status === 'pending_review' && <span className="w-2 h-2 bg-red-500 rounded-full"></span>}
                      </div>
                      <span className="text-xs text-slate-400">{msg.time}</span>
                    </div>
                    <p className="text-sm text-slate-500 truncate mb-2 font-medium">{msg.lastMessage}</p>
                    <div className="flex items-center justify-between">
                       <div className="flex items-center gap-1.5 bg-white border border-slate-200 px-2 py-0.5 rounded text-[10px] text-slate-500">
                          <PlatformIcon platform={msg.platform} />
                          {msg.platform}
                       </div>
                       {msg.status === 'replied' && <CheckCircle className="w-3 h-3 text-green-500" />}
                    </div>
                  </div>
                )) : (
                    <div className="p-8 text-center text-slate-400 text-sm">ç„¡ç¬¦åˆæœå°‹çµæœ</div>
                )}
              </div>
            </div>
            
            {/* Chat Detail */}
            <div className="flex-1 flex flex-col bg-[#F8F9FA] relative">
              {selectedMsg ? (
                <>
                  <div className="p-4 bg-white border-b border-slate-100 flex justify-between items-center shadow-sm z-10">
                    <div className="flex items-center gap-3">
                      <img src={selectedMsg.avatar} className="w-10 h-10 rounded-full" alt="" />
                      <div>
                        <h3 className="font-bold text-slate-800 flex items-center gap-2">
                          {selectedMsg.client}
                          <PlatformIcon platform={selectedMsg.platform} />
                        </h3>
                        <div className="text-xs text-slate-500">ä¾†æºï¼š{selectedMsg.platform} ç§è¨Š</div>
                      </div>
                    </div>
                    {/* View Client Detail Button */}
                    <button 
                        onClick={() => handleViewClientDetail(clients.find(c => c.name === selectedMsg.client))}
                        className="p-2 bg-white border border-slate-200 rounded-lg text-slate-600 hover:bg-slate-50 hover:text-orange-500 transition-colors tooltip"
                        title="æŸ¥çœ‹å®¢æˆ¶è©³ç´°è³‡è¨Š"
                    >
                        <Info className="w-5 h-5" />
                    </button>
                  </div>

                  <div className="flex-1 p-6 space-y-6 overflow-y-auto pb-24">
                     {selectedMsg.history.map((h, i) => (
                       <div key={i} className={`flex flex-col gap-1 ${h.sender === 'client' ? 'items-start' : 'items-end'}`}>
                          <div className={`flex gap-3 ${h.sender === 'client' ? '' : 'flex-row-reverse'}`}>
                            <div className={`p-3 rounded-2xl shadow-sm max-w-[80%] whitespace-pre-wrap relative group ${h.sender === 'client' ? 'bg-white' : h.type === 'system' ? 'bg-slate-200 text-slate-600' : 'bg-orange-500 text-white'}`}>
                              {h.text}
                            </div>
                          </div>
                          {/* Timestamp Always Visible */}
                          {h.time && h.type !== 'system' && (
                              <span className={`text-[10px] text-slate-400 ${h.sender === 'client' ? 'ml-1' : 'mr-1'} mb-2`}>
                                  {h.time}
                              </span>
                          )}
                          {h.type === 'system' && h.showCalendarBtn && (
                             <button 
                                onClick={handleAddToCalendar}
                                className="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full border border-blue-100 hover:bg-blue-100 font-bold flex items-center gap-1 mb-2 self-center"
                             >
                                <CalendarPlus className="w-3 h-3" /> åŠ å…¥ Google è¡Œäº‹æ›†
                             </button>
                          )}
                       </div>
                     ))}
                     
                     {/* AI Suggestion Box */}
                     {selectedMsg.status === 'pending_review' && (
                       <div className="bg-orange-50 border border-orange-200 rounded-2xl p-5 mx-8 shadow-sm animate-in fade-in slide-in-from-bottom-2">
                          <div className="flex items-center justify-between mb-3">
                             <div className="flex items-center gap-2 text-orange-700 font-bold text-sm">
                                <Sparkles className="w-4 h-4" /> ZuZu å»ºè­°å›è¦†
                             </div>
                             {/* Product Recommendation Button */}
                             <button 
                                onClick={() => handleRecommendProduct(selectedMsg.id)}
                                className="text-xs bg-white border border-orange-200 text-orange-600 px-2 py-1 rounded-lg hover:bg-orange-50 transition-colors flex items-center gap-1"
                             >
                                <Gift className="w-3 h-3" /> æ¨è–¦æœå‹™
                             </button>
                          </div>
                          
                          <textarea 
                            ref={textareaRef}
                            className="w-full bg-white border border-orange-200 rounded-xl p-3 text-sm mb-3 focus:outline-none focus:ring-2 focus:ring-orange-200 resize-none" 
                            rows="4" 
                            value={getCurrentDraft(selectedMsg)} 
                            onChange={(e) => handleDraftEdit(selectedMsg.id, e.target.value)}
                            readOnly={isRegenerating}
                          />
                          
                          <div className="flex gap-2 mb-4 bg-white p-1 pl-3 border border-orange-200 rounded-xl shadow-sm">
                             <input 
                               type="text" 
                               value={aiInstruction}
                               onChange={(e) => setAiInstruction(e.target.value)}
                               placeholder="çµ¦ AI å»ºè­°... (ä¾‹å¦‚ï¼šèªæ°£å†è¦ªåˆ‡ä¸€é»)" 
                               className="flex-1 text-sm outline-none text-slate-700 bg-transparent py-2"
                               disabled={isRegenerating}
                               onKeyDown={(e) => e.key === 'Enter' && handleRefineDraft(selectedMsg.id)}
                             />
                             <button 
                               onClick={() => handleRefineDraft(selectedMsg.id)}
                               disabled={!aiInstruction.trim() || isRegenerating}
                               className="bg-orange-100 text-orange-700 hover:bg-orange-200 px-4 rounded-lg text-xs font-bold flex items-center gap-1"
                             >
                               {isRegenerating ? <Loader2 className="w-3 h-3 animate-spin"/> : <Sparkles className="w-3 h-3"/>}
                               AI ä¿®æ”¹
                             </button>
                          </div>

                          <div className="flex gap-3 justify-end border-t border-orange-200/50 pt-3">
                             <button onClick={handleManualEditClick} className="px-4 py-2 text-sm font-medium text-slate-500 hover:bg-white rounded-lg flex items-center gap-2"><Edit3 className="w-3 h-3"/> æ‰‹å‹•ç·¨è¼¯</button>
                             <button onClick={() => handleSendMessage(selectedMsg.id)} className="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-sm shadow-orange-200"><Send className="w-4 h-4" /> ç¢ºèªç™¼é€</button>
                          </div>
                       </div>
                     )}
                     <div ref={chatEndRef} />
                  </div>
                  
                  {/* General Chat Input (UPDATED: Auto resize textarea) */}
                  <div className="p-4 bg-white border-t border-slate-100 absolute bottom-0 w-full shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                     <div className="flex gap-2 items-end">
                        <div className="flex-1 relative">
                            <textarea 
                                ref={inputRef}
                                value={manualInput}
                                onChange={handleInputResize}
                                onKeyDown={(e) => {
                                  if(e.key === 'Enter' && !e.shiftKey) {
                                    e.preventDefault();
                                    handleManualSend(selectedMsg.id);
                                  }
                                }}
                                placeholder="è‡ªè¡Œè¼¸å…¥è¨Šæ¯æˆ–é»é¸å³å´æ˜Ÿæ˜Ÿå†æ¬¡ç”Ÿæˆç›¸é—œè¨Šæ¯..." 
                                className="w-full bg-slate-50 border-transparent focus:bg-white border focus:border-orange-300 rounded-xl pl-4 pr-10 py-2.5 text-sm focus:outline-none transition-all resize-none overflow-y-auto"
                                style={{ minHeight: '44px', maxHeight: '150px' }}
                                rows="1"
                            />
                            <button 
                                onClick={handleGenerateManualInput}
                                className="absolute right-2 top-2 p-1 text-slate-400 hover:text-purple-600 transition-colors tooltip"
                                title="AI ç”Ÿæˆå»ºè­°"
                            >
                                {isPolishing ? <Loader2 className="w-4 h-4 animate-spin"/> : <Sparkles className="w-4 h-4"/>}
                            </button>
                        </div>
                        <button 
                            onClick={() => handleManualSend(selectedMsg.id)}
                            disabled={!manualInput.trim()}
                            className="p-2.5 bg-slate-900 text-white rounded-xl hover:bg-slate-800 transition-colors disabled:opacity-50 mb-1"
                        >
                           <Send className="w-5 h-5" />
                        </button>
                     </div>
                  </div>
                </>
              ) : <div className="flex-1 flex items-center justify-center text-slate-400">è«‹é¸æ“‡è¨Šæ¯</div>}
            </div>
          </div>
        )}

        {/* --- MARKETING TAB (UPDATED RESTRUCTURE) --- */}
        {activeTab === 'marketing' && (
          <div className="space-y-6 animate-in fade-in duration-500 h-full flex flex-col">
             <div className="flex flex-col md:flex-row justify-between items-end gap-4 shrink-0">
                <div>
                   <h2 className="text-2xl font-bold text-slate-800">è¡ŒéŠ·åŠ©æ‰‹</h2>
                   <p className="text-slate-500">é¸æ“‡åŠŸèƒ½ï¼Œè®“ AI å”åŠ©æ‚¨çš„æ¥­å‹™æ¨å»£ã€‚</p>
                </div>
                {/* Main Marketing Navigation */}
                <div className="flex bg-white p-1 rounded-xl border border-slate-200">
                    {[
                        { id: 'messages', label: 'è¨Šæ¯è¡ŒéŠ·', icon: Megaphone },
                        { id: 'copywriting', label: 'ç¤¾ç¾¤æ–‡æ¡ˆ', icon: Edit3 },
                        { id: 'ads', label: 'å»£å‘ŠæŠ•æ”¾', icon: MousePointer2 },
                        { id: 'influencers', label: 'ç¶²ç´…åª’åˆ', icon: UserPlus },
                    ].map(tab => (
                        <button 
                            key={tab.id}
                            onClick={() => setMarketingSubTab(tab.id)}
                            className={`px-4 py-2 rounded-lg text-sm font-bold transition-all flex items-center gap-2 ${marketingSubTab === tab.id ? 'bg-slate-900 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}
                        >
                            <tab.icon className="w-4 h-4" /> {tab.label}
                        </button>
                    ))}
                </div>
             </div>

             <div className="flex-1 overflow-y-auto pr-2 pb-24">
                {/* --- 1. MESSAGES SUBTAB (Includes Churn & Broadcast) --- */}
                {marketingSubTab === 'messages' && (
                    <div className="space-y-8 animate-in fade-in slide-in-from-bottom-2">
                        {/* Broadcast Section */}
                        <div className="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-4 text-lg">
                                <Megaphone className="w-5 h-5 text-orange-500" /> ä¸€éµåˆ†çœ¾å®£å‚³ (Broadcast)
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="md:col-span-1 space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">é¸æ“‡ç›®æ¨™å—çœ¾ (Tags)</label>
                                        <select 
                                            value={broadcastTag} 
                                            onChange={(e) => setBroadcastTag(e.target.value)}
                                            className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 font-medium focus:ring-2 focus:ring-orange-200 outline-none"
                                        >
                                            <option value="all">æ‰€æœ‰å®¢æˆ¶ ({clients.length}äºº)</option>
                                            {uniqueClientTags.map(tag => (
                                                <option key={tag} value={tag}>{tag} ({clients.filter(c => c.tags.includes(tag)).length}äºº)</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="bg-orange-50 p-4 rounded-xl">
                                        <h4 className="font-bold text-orange-700 text-sm mb-1">AI å»ºè­°</h4>
                                        <p className="text-xs text-orange-600">é‡å°ã€Œ{broadcastTag === 'all' ? 'æ‰€æœ‰å®¢æˆ¶' : broadcastTag}ã€ï¼Œå»ºè­°æ‚¨å¯ä»¥ç™¼é€æ–°å“ä¸Šå¸‚é€šçŸ¥æˆ–é™æ™‚å„ªæƒ ã€‚</p>
                                    </div>
                                </div>
                                <div className="md:col-span-2 flex flex-col">
                                    <textarea 
                                        value={broadcastMsg}
                                        onChange={(e) => setBroadcastMsg(e.target.value)}
                                        placeholder="è¼¸å…¥æ¨æ’­è¨Šæ¯å…§å®¹..." 
                                        className="flex-1 w-full p-4 bg-slate-50 border border-slate-200 rounded-xl mb-4 focus:ring-2 focus:ring-orange-200 outline-none resize-none"
                                        rows="4"
                                    />
                                    <div className="flex justify-end">
                                        <button 
                                            onClick={handleBroadcast}
                                            disabled={!broadcastMsg.trim() || isBroadcasting}
                                            className="bg-orange-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-orange-200 hover:bg-orange-600 disabled:opacity-50 flex items-center gap-2"
                                        >
                                            {isBroadcasting ? <Loader2 className="w-4 h-4 animate-spin"/> : <Send className="w-4 h-4"/>}
                                            ç™¼é€çµ¦ {broadcastTag === 'all' ? clients.length : clients.filter(c => c.tags.includes(broadcastTag)).length} ä½å®¢æˆ¶
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Churn Wake Up Section (Moved from Analysis) */}
                        <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                            <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-4 text-lg">
                               <Users className="w-5 h-5 text-red-500" />
                               æ²‰ç¡å®¢ç¾¤å–šé†’ (è¶…é 60 å¤©æœªäº’å‹•)
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {[
                                    { name: "Amy", last: "65å¤©å‰", value: "é«˜æ½›åŠ›", industry: "ç¾æ¥­", lastContact: "2025-09-10" },
                                    { name: "Jason æ”å½±", last: "82å¤©å‰", value: "ä¸­æ½›åŠ›", industry: "æ”å½±", lastContact: "2025-08-24" },
                                    { name: "Lisa", last: "90å¤©å‰", value: "ä½æ½›åŠ›", industry: "å…¶ä»–", lastContact: "2025-08-16" }
                                ].map((client, i) => (
                                    <div key={i} className="p-4 border border-slate-100 rounded-xl hover:border-red-200 transition-colors group">
                                        <div className="flex justify-between items-start mb-2">
                                            <div className="font-bold text-slate-700">{client.name}</div>
                                            <span className="text-[10px] bg-red-50 text-red-600 px-2 py-0.5 rounded font-bold">{client.last}</span>
                                        </div>
                                        <div className="text-xs text-slate-400 mb-4">ä¸Šæ¬¡æœå‹™ï¼šç³»çµ±æ¶è¨­è«®è©¢</div>
                                        <button 
                                            onClick={() => handleGenerateReengagement(client)}
                                            className="w-full py-2 bg-white border border-red-100 text-red-600 text-xs font-bold rounded-lg hover:bg-red-50 flex items-center justify-center gap-1 group-hover:shadow-sm"
                                        >
                                            <Sparkles className="w-3 h-3" /> ç”Ÿæˆå–šé†’è¨Šæ¯
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                )}

                {/* --- 2. COPYWRITING SUBTAB (Existing Logic) --- */}
                {marketingSubTab === 'copywriting' && (
                    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-2">
                        <div className="flex overflow-x-auto gap-2 pb-2">
                             {[
                                { id: 'trends', label: 'ğŸ”¥ ç”¢æ¥­è©±é¡Œ' },
                                { id: 'success', label: 'ğŸ† æˆåŠŸæ¡ˆä¾‹' },
                                { id: 'features', label: 'âš¡ åŠŸèƒ½å®£å‚³' },
                                { id: 'inspiration', label: 'ğŸ’¡ éˆæ„Ÿç™¼æƒ³' }
                            ].map(cat => (
                                <button 
                                    key={cat.id}
                                    onClick={() => {setMarketingCategory(cat.id); setMarketingStep('crawler'); setInspirationInput("");}}
                                    className={`px-4 py-2 rounded-full text-xs font-bold transition-all whitespace-nowrap border ${marketingCategory === cat.id ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}
                                >
                                    {cat.label}
                                </button>
                            ))}
                        </div>

                         {/* Inspiration Mode */}
                         {marketingCategory === 'inspiration' && marketingStep === 'crawler' && (
                             <div className="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm text-center space-y-6">
                                 <div className="w-16 h-16 bg-yellow-50 rounded-full flex items-center justify-center mx-auto text-yellow-500">
                                     <Lightbulb className="w-8 h-8" />
                                 </div>
                                 <div>
                                     <h3 className="text-xl font-bold text-slate-800">æœ‰ä»€éº¼æ–°é»å­å—ï¼Ÿ</h3>
                                     <p className="text-slate-500 mt-2">éš¨æ‰‹å¯«ä¸‹æ‚¨çš„å°æ•…äº‹æˆ–æƒ³æ³•ï¼ŒAI å¹«æ‚¨è®Šæˆå¸ç›è²¼æ–‡ã€‚</p>
                                 </div>
                                 <textarea 
                                    className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-yellow-400 focus:ring-2 focus:ring-yellow-100 transition-all min-h-[150px]"
                                    placeholder="ä¾‹å¦‚ï¼šä»Šå¤©é‡åˆ°ä¸€å€‹å¾ˆå¯æ„›çš„å®¢äººï¼Œå¥¹èªª..."
                                    value={inspirationInput}
                                    onChange={(e) => setInspirationInput(e.target.value)}
                                 />
                                 <button 
                                    onClick={() => handleGeneratePost(null, 'inspiration')}
                                    disabled={!inspirationInput.trim()}
                                    className="bg-slate-900 text-white px-8 py-3 rounded-xl font-bold hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                                 >
                                    âœ¨ é–‹å§‹ç”Ÿæˆè²¼æ–‡
                                 </button>
                             </div>
                         )}

                         {/* Content Grid */}
                         {marketingCategory !== 'inspiration' && marketingStep === 'crawler' && (
                           <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                             {/* Trends */}
                             {marketingCategory === 'trends' && filteredArticles.map(item => (
                               <div key={item.id} onClick={() => setShowArticleModal(item)} className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all flex flex-col h-full group cursor-pointer">
                                  <div className="flex items-center gap-2 mb-3">
                                     <Globe className="w-4 h-4 text-blue-500" />
                                     <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">{item.source}</span>
                                  </div>
                                  <h3 className="text-lg font-bold text-slate-800 mb-2 group-hover:text-orange-600 transition-colors">{item.title}</h3>
                                  <p className="text-sm text-slate-500 mb-4 flex-1 line-clamp-3">{item.summary}</p>
                                  <button onClick={(e) => { e.stopPropagation(); handleGeneratePost(item, 'trends'); }} className="w-full bg-white border border-slate-200 text-slate-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-orange-50 hover:text-orange-600 hover:border-orange-200 transition-all">
                                    <Sparkles className="w-4 h-4" /> ç”Ÿæˆè²¼æ–‡
                                  </button>
                               </div>
                             ))}
                             {/* Success Stories Logic */}
                             {marketingCategory === 'success' && clients.filter(c => c.status === 'å·²ç°½ç´„').map(client => (
                               <div key={client.id} className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all flex flex-col h-full group">
                                  <div className="flex items-center gap-2 mb-3">
                                     <Award className="w-4 h-4 text-yellow-500" />
                                     <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">æˆäº¤å®¢æˆ¶</span>
                                  </div>
                                  <h3 className="text-lg font-bold text-slate-800 mb-2">{client.company}</h3>
                                  <p className="text-sm text-slate-500 mb-4 flex-1">
                                      <span className="font-bold">ç—›é»ï¼š</span>{client.notes}<br/>
                                      <span className="font-bold">æ–¹æ¡ˆï¼š</span>{client.plan} æ–¹æ¡ˆ
                                  </p>
                                  <button onClick={() => handleGeneratePost(client, 'success')} className="w-full bg-white border border-slate-200 text-slate-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-yellow-50 hover:text-yellow-600 hover:border-yellow-200 transition-all">
                                    <Sparkles className="w-4 h-4" /> æ’°å¯«æ¡ˆä¾‹
                                  </button>
                               </div>
                             ))}
                             {/* Features Promo Logic */}
                             {marketingCategory === 'features' && [
                                 { id: 1, title: '24H è‡ªå‹•é ç´„', desc: 'åŠå¤œä¹Ÿèƒ½è‡ªå‹•æ¥å–®ï¼Œä¸éŒ¯éä»»ä½•ç”Ÿæ„ã€‚', painPoint: 'å¸¸å¸¸åœ¨å¿™ç¢Œæ™‚ç„¡æ³•å›è¦†è¨Šæ¯ï¼Ÿ' },
                                 { id: 2, title: 'LINE æ™ºæ…§å®¢æœ', desc: 'ä¸²æ¥å®˜æ–¹å¸³è™Ÿï¼Œè‡ªå‹•å›è¦†å¸¸è¦‹å•é¡Œã€‚', painPoint: 'é‡è¤‡çš„å•é¡Œå›ç­”äº†ä¸€ç™¾éè¦ºå¾—å¿ƒç´¯ï¼Ÿ' }
                             ].map(feat => (
                               <div key={feat.id} className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all flex flex-col h-full group">
                                  <div className="flex items-center gap-2 mb-3">
                                     <Zap className="w-4 h-4 text-purple-500" />
                                     <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">æ ¸å¿ƒåŠŸèƒ½</span>
                                  </div>
                                  <h3 className="text-lg font-bold text-slate-800 mb-2">{feat.title}</h3>
                                  <p className="text-sm text-slate-500 mb-4 flex-1">{feat.desc}</p>
                                  <button onClick={() => handleGeneratePost(feat, 'features')} className="w-full bg-white border border-slate-200 text-slate-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-purple-50 hover:text-purple-600 hover:border-purple-200 transition-all">
                                    <Sparkles className="w-4 h-4" /> æ¨å»£æ­¤åŠŸèƒ½
                                  </button>
                               </div>
                             ))}
                           </div>
                         )}

                         {/* Editor / Loading States */}
                         {marketingStep === 'loading' && (
                           <div className="h-64 flex flex-col items-center justify-center text-center">
                             <Loader2 className="w-16 h-16 text-orange-500 animate-spin mb-4" />
                             <h3 className="font-bold text-slate-800 text-lg">AI æ­£åœ¨æ’°å¯«è²¼æ–‡...</h3>
                             <p className="text-slate-500">åˆ†æç›¸é—œæ•¸æ“šèˆ‡èªæ°£ä¸­</p>
                           </div>
                         )}

                         {marketingStep === 'editor' && (
                           <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden flex flex-col md:flex-row">
                              <div className="flex-1 p-8 border-r border-slate-100">
                                 <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                       <Edit3 className="w-5 h-5 text-orange-500" /> è²¼æ–‡ç·¨è¼¯å™¨
                                    </h3>
                                 </div>
                                 <textarea 
                                   className="w-full h-64 p-4 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 focus:outline-none focus:ring-2 focus:ring-orange-200 resize-none leading-relaxed"
                                   value={generatedPost}
                                   onChange={(e) => setGeneratedPost(e.target.value)}
                                 />
                                 <div className="flex justify-between mt-4">
                                    <button onClick={() => setMarketingStep('crawler')} className="text-slate-500 font-medium hover:text-slate-800">å–æ¶ˆ</button>
                                    <div className="flex gap-2">
                                        <button onClick={() => {setIsPolishing(true); setTimeout(() => {setGeneratedPost(p => p + "\n\n(AI æ½¤é£¾ï¼šèªæ°£æ›´æ´»æ½‘äº†ï¼)"); setIsPolishing(false);}, 800);}} className="px-4 py-2 border border-slate-200 rounded-lg text-slate-600 hover:bg-slate-50 font-bold flex items-center gap-2">
                                            {isPolishing ? <Loader2 className="w-3 h-3 animate-spin"/> : <Sparkles className="w-3 h-3"/>} AI æ½¤é£¾
                                        </button>
                                        <button onClick={handlePublishPost} className="px-6 py-2 bg-orange-500 text-white rounded-lg font-bold hover:bg-orange-600 shadow-lg shadow-orange-200">ç«‹å³ç™¼ä½ˆ</button>
                                    </div>
                                 </div>
                              </div>
                           </div>
                         )}
                    </div>
                )}

                {/* --- 3. ADS SUBTAB (Placeholder) --- */}
                {marketingSubTab === 'ads' && (
                    <div className="flex flex-col items-center justify-center h-64 text-center animate-in fade-in slide-in-from-bottom-2">
                        <div className="p-4 bg-slate-100 rounded-full mb-4">
                            <MousePointer2 className="w-8 h-8 text-slate-400" />
                        </div>
                        <h3 className="text-lg font-bold text-slate-800">å»£å‘ŠæŠ•æ”¾åŠŸèƒ½å³å°‡ä¸Šç·š</h3>
                        <p className="text-slate-500 max-w-sm mt-2">æœªä¾†æ‚¨å°‡èƒ½ç›´æ¥åœ¨æ­¤è¨­å®š Meta èˆ‡ Google å»£å‘Šï¼Œä¸¦ç”± AI è‡ªå‹•å„ªåŒ–é ç®—ã€‚</p>
                    </div>
                )}

                {/* --- 4. INFLUENCERS SUBTAB (Placeholder) --- */}
                {marketingSubTab === 'influencers' && (
                    <div className="flex flex-col items-center justify-center h-64 text-center animate-in fade-in slide-in-from-bottom-2">
                        <div className="p-4 bg-slate-100 rounded-full mb-4">
                            <UserPlus className="w-8 h-8 text-slate-400" />
                        </div>
                        <h3 className="text-lg font-bold text-slate-800">ç¶²ç´…åª’åˆåŠŸèƒ½å³å°‡ä¸Šç·š</h3>
                        <p className="text-slate-500 max-w-sm mt-2">AI å°‡æ ¹æ“šæ‚¨çš„å“ç‰Œé¢¨æ ¼ï¼Œè‡ªå‹•æ¨è–¦é©åˆçš„å¾®ç¶²ç´…é€²è¡Œäº’æƒ æˆ–ä»˜è²»åˆä½œã€‚</p>
                    </div>
                )}
             </div>
          </div>
        )}

        {/* --- CALENDAR TAB --- */}
        {activeTab === 'calendar' && (
          <div className="space-y-4 animate-in fade-in duration-500 h-full flex flex-col">
             <div className="flex flex-col md:flex-row justify-between items-center mb-2 gap-4">
                 <h2 className="text-2xl font-bold text-slate-800">é ç´„è¡Œäº‹æ›† (ç¤ºç¯„)</h2>
                 <div className="flex bg-white p-1 rounded-lg border border-slate-200">
                    <button onClick={() => setCalendarView('week')} className={`px-3 py-1 rounded text-sm font-bold ${calendarView === 'week' ? 'bg-slate-100 text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}>é€±è¦–åœ–</button>
                    <button onClick={() => setCalendarView('month')} className={`px-3 py-1 rounded text-sm font-bold ${calendarView === 'month' ? 'bg-slate-100 text-slate-800' : 'text-slate-500 hover:text-slate-700'}`}>æœˆè¦–åœ–</button>
                 </div>
             </div>
             
             {/* WEEK VIEW */}
             {calendarView === 'week' && (
                <div className="bg-white border border-slate-200 rounded-2xl flex-1 flex flex-col overflow-hidden shadow-sm">
                    {/* Header Days */}
                    <div className="flex border-b border-slate-200">
                        <div className="w-16 p-3 bg-slate-50 border-r border-slate-200"></div>
                        {['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­', 'é€±æ—¥'].map((d, i) => (
                            <div key={d} className="flex-1 p-3 text-center border-r border-slate-100 last:border-0 bg-slate-50">
                                <div className={`text-xs font-bold ${d === 'é€±äº”' ? 'text-orange-600' : 'text-slate-500'}`}>{d}</div>
                                <div className={`text-sm font-bold ${d === 'é€±äº”' ? 'text-orange-600' : 'text-slate-800'}`}>{10 + i}</div>
                            </div>
                        ))}
                    </div>
                    {/* Grid */}
                    <div className="flex-1 overflow-y-auto relative bg-white">
                        {/* Time Slots */}
                        {[9, 10, 11, 12, 13, 14, 15, 16, 17, 18].map(hour => (
                            <div key={hour} className="flex h-20 border-b border-slate-100">
                                <div className="w-16 p-2 text-xs text-slate-400 text-right border-r border-slate-200 pr-3">{hour}:00</div>
                                {/* Columns */}
                                {[0,1,2,3,4,5,6].map(col => (
                                    <div key={col} className={`flex-1 border-r border-slate-50 relative ${col === 4 ? 'bg-orange-50/20' : ''}`}></div>
                                ))}
                            </div>
                        ))}

                        {/* Events based on ALL_DATA for the week 11/10 - 11/16 */}
                        {ALL_DATA.filter(a => a.date === CURRENT_DATE).map(apt => {
                            const startHour = parseInt(apt.time.split(':')[0]);
                            const top = (startHour - 9) * 80; 
                            const left = `calc(4rem + ((100% - 4rem) / 7) * 4)`; // Friday column
                            return (
                                <div key={apt.id} className="absolute w-[calc((100%-4rem)/7-4px)] h-20 m-0.5 bg-orange-100 border-l-4 border-orange-500 rounded p-2 text-xs shadow-sm cursor-pointer hover:shadow-md" style={{top: `${top}px`, left: left}}>
                                    <div className="font-bold text-orange-700">{apt.time} {apt.service}</div>
                                    <div className="text-orange-600">{apt.client}</div>
                                </div>
                            );
                        })}
                        
                        {/* Other days dummy data visual */}
                        <div className="absolute top-[80px] left-[calc(4rem+((100%-4rem)/7)*1)] w-[calc((100%-4rem)/7-4px)] h-20 m-0.5 bg-blue-100 border-l-4 border-blue-500 rounded p-2 text-xs shadow-sm cursor-pointer hover:shadow-md">
                            <div className="font-bold text-blue-700">10:00 è«®è©¢</div>
                            <div className="text-blue-600">Kevin æ—</div>
                        </div>
                    </div>
                </div>
             )}
             
             {/* MONTH VIEW */}
             {calendarView === 'month' && (
                 <div className="bg-white border border-slate-200 rounded-2xl flex-1 flex flex-col p-4 shadow-sm h-full overflow-hidden">
                     <div className="grid grid-cols-7 mb-2">
                        {['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map(d => (
                            <div key={d} className="text-center text-xs font-bold text-slate-400 uppercase py-2">{d}</div>
                        ))}
                     </div>
                     <div className="grid grid-cols-7 grid-rows-5 gap-2 flex-1">
                        {Array.from({length: 35}, (_, i) => {
                            const day = i - 2; 
                            const isCurrentMonth = day > 0 && day <= 30;
                            const isToday = day === 14;
                            const hasEvent = [5, 8, 14, 15, 16, 18, 20].includes(day); 
                            
                            return (
                                <div key={i} className={`border rounded-lg p-2 flex flex-col justify-between ${isToday ? 'border-orange-500 bg-orange-50' : 'border-slate-100'} ${!isCurrentMonth ? 'bg-slate-50/50' : 'bg-white'}`}>
                                    <span className={`text-sm font-bold ${isToday ? 'text-orange-600' : isCurrentMonth ? 'text-slate-700' : 'text-slate-300'}`}>
                                        {isCurrentMonth ? day : ''}
                                    </span>
                                    {isCurrentMonth && hasEvent && (
                                        <div className="flex flex-col gap-1 mt-1">
                                            <div className="h-1.5 w-full bg-blue-200 rounded-full"></div>
                                            {day === 14 && <div className="h-1.5 w-3/4 bg-orange-300 rounded-full"></div>}
                                            {day === 14 && <div className="h-1.5 w-1/2 bg-green-200 rounded-full"></div>}
                                        </div>
                                    )}
                                </div>
                            )
                        })}
                     </div>
                 </div>
             )}
          </div>
        )}

        {/* --- ORDERS TAB --- */}
        {activeTab === 'orders' && (
            <div className="space-y-4 animate-in fade-in duration-500 h-full flex flex-col">
                <div className="flex flex-col md:flex-row justify-between items-center mb-2 gap-4">
                    <h2 className="text-2xl font-bold text-slate-800">è¨‚å–®ç®¡ç†</h2>
                    <div className="flex gap-2">
                        <select 
                            value={orderFilterIndustry} 
                            onChange={(e) => setOrderFilterIndustry(e.target.value)}
                            className="bg-white border border-slate-200 text-slate-700 text-sm rounded-lg px-3 py-2 outline-none focus:border-orange-300"
                        >
                            <option value="all">æ‰€æœ‰ç”¢æ¥­</option>
                            {uniqueIndustries.map(ind => <option key={ind} value={ind}>{ind}</option>)}
                        </select>
                        <select 
                            value={orderFilterDate} 
                            onChange={(e) => setOrderFilterDate(e.target.value)}
                            className="bg-white border border-slate-200 text-slate-700 text-sm rounded-lg px-3 py-2 outline-none focus:border-orange-300"
                        >
                            <option value="all">æ‰€æœ‰æ—¥æœŸ</option>
                            {uniqueDates.map(d => <option key={d} value={d}>{d}</option>)}
                        </select>
                        <select 
                            value={orderFilterStatus} 
                            onChange={(e) => setOrderFilterStatus(e.target.value)}
                            className="bg-white border border-slate-200 text-slate-700 text-sm rounded-lg px-3 py-2 outline-none focus:border-orange-300"
                        >
                            <option value="all">æ‰€æœ‰ä»˜æ¬¾ç‹€æ…‹</option>
                            <option value="paid">å·²ä»˜æ¬¾</option>
                            <option value="unpaid">æœªä»˜æ¬¾</option>
                        </select>
                    </div>
                </div>

                <div className="bg-white border border-slate-200 rounded-2xl flex-1 overflow-hidden shadow-sm">
                   <table className="w-full text-left">
                       <thead className="bg-slate-50 border-b border-slate-100 text-xs uppercase text-slate-500">
                           <tr>
                               <th className="p-4">æ—¥æœŸ</th>
                               <th className="p-4">æ™‚é–“</th>
                               <th className="p-4">å®¢æˆ¶</th>
                               <th className="p-4">ç”¢æ¥­/æ–¹æ¡ˆ</th>
                               <th className="p-4">æœå‹™é …ç›®</th>
                               <th className="p-4">é‡‘é¡</th>
                               <th className="p-4">ä»˜æ¬¾ç‹€æ…‹</th>
                           </tr>
                       </thead>
                       <tbody className="divide-y divide-slate-50">
                           {filteredOrders.length > 0 ? filteredOrders.map(apt => (
                               <tr key={apt.id} className="hover:bg-slate-50 cursor-pointer" onClick={() => showNotification(`æŸ¥çœ‹è¨‚å–® #${apt.id} è©³æƒ…...`)}>
                                   <td className="p-4 text-sm font-bold text-slate-700">{apt.date}</td>
                                   <td className="p-4 text-sm text-slate-600">{apt.time}</td>
                                   <td className="p-4 text-sm font-medium">{apt.client}</td>
                                   <td className="p-4 text-sm text-slate-500">
                                       <span className="bg-slate-100 px-2 py-0.5 rounded text-[10px] mr-1">{apt.industry}</span>
                                       <span className={`px-2 py-0.5 rounded text-[10px] ${apt.plan === 'Pro' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-600'}`}>{apt.plan || 'N/A'}</span>
                                   </td>
                                   <td className="p-4 text-sm text-slate-500">{apt.service}</td>
                                   <td className="p-4 text-sm font-bold">NT$ {apt.amount.toLocaleString()}</td>
                                   <td className="p-4">
                                       <span className={`text-xs px-2 py-1 rounded-full font-bold ${apt.payment === 'paid' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                           {apt.payment === 'paid' ? 'å·²ä»˜æ¬¾' : 'æœªä»˜æ¬¾'}
                                       </span>
                                   </td>
                               </tr>
                           )) : (
                               <tr><td colSpan="7" className="p-8 text-center text-slate-400">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„è¨‚å–®</td></tr>
                           )}
                       </tbody>
                   </table>
                </div>
            </div>
        )}

        {/* --- FINANCE TAB --- */}
        {activeTab === 'finance' && (
            <div className="space-y-8 animate-in fade-in duration-500">
                <div className="flex justify-between items-center">
                    <h2 className="text-2xl font-bold text-slate-800">é‡‘æµèˆ‡ç‡Ÿæ”¶åˆ†æ</h2>
                </div>
                
                {/* Metrics */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <StatCard title="ç¸½ç‡Ÿæ”¶ (æœ¬æœˆ)" value="NT$ 125,000" icon={DollarSign} color="bg-yellow-100 text-yellow-600" />
                    <StatCard title="å¹³å‡å®¢å–®åƒ¹ (AOV)" value="NT$ 2,500" icon={TrendingUp} color="bg-green-100 text-green-600" />
                    <StatCard title="æˆåŠŸè¨‚å–®æ•¸" value="50" icon={CheckCircle} color="bg-blue-100 text-blue-600" />
                </div>

                {/* Charts */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    {/* Revenue Bar Chart + Line Chart (Hybrid) */}
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                <BarChart2 className="w-5 h-5 text-purple-500" />
                                æ¯æ—¥ç‡Ÿæ”¶è¶¨å‹¢ (è¿‘7æ—¥)
                            </h3>
                            <span className="text-xs text-green-600 font-bold bg-green-50 px-2 py-1 rounded">
                                +12% æˆé•·
                            </span>
                        </div>
                        <div className="h-48 relative">
                             {/* Simulated Line Chart using SVG */}
                             <svg className="absolute inset-0 w-full h-full pointer-events-none z-10" viewBox="0 0 100 100" preserveAspectRatio="none">
                                <defs>
                                    <linearGradient id="lineGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" stopColor="rgba(249, 115, 22, 0.5)" />
                                        <stop offset="100%" stopColor="rgba(249, 115, 22, 0)" />
                                    </linearGradient>
                                </defs>
                                <path 
                                    d="M5,60 L19,50 L33,73 L47,26 L61,40 L75,16 L90,36" 
                                    fill="none" 
                                    stroke="#f97316" 
                                    strokeWidth="2" 
                                    strokeLinecap="round"
                                    vectorEffect="non-scaling-stroke"
                                />
                                <path 
                                    d="M5,60 L19,50 L33,73 L47,26 L61,40 L75,16 L90,36 L90,100 L5,100 Z" 
                                    fill="url(#lineGradient)" 
                                    stroke="none"
                                    opacity="0.3"
                                />
                                {/* Dots */}
                                {[60, 50, 73, 26, 40, 16, 36].map((y, i) => (
                                    <circle key={i} cx={5 + i*14.16} cy={y} r="1" fill="#f97316" stroke="white" strokeWidth="0.5" />
                                ))}
                             </svg>

                            <div className="flex items-end justify-between h-full gap-3 pb-6">
                                {[12000, 15000, 8000, 22000, 18000, 25000, 19000].map((val, i) => (
                                    <div key={i} className="flex-1 flex flex-col justify-end group items-center relative z-0">
                                        {/* Value Label - Always Visible */}
                                        <div className="text-[10px] text-slate-500 font-bold mb-1">
                                            ${val/1000}k
                                        </div>
                                        <div className="w-full bg-purple-100 rounded-t-md relative hover:bg-purple-200 transition-colors" style={{height: `${val/300}%`}}>
                                        </div>
                                        <span className="text-[10px] text-center text-slate-400 absolute -bottom-5 w-full">{['11/08', '11/09', '11/10', '11/11', '11/12', '11/13', '11/14'][i]}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Industry Pie Chart */}
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                <PieChart className="w-5 h-5 text-orange-500" />
                                å®¢ç¾¤ç”¢æ¥­åˆ†ä½ˆ
                            </h3>
                        </div>
                        <div className="flex items-center gap-8">
                            <div className="relative w-32 h-32 rounded-full border-8 border-slate-100" 
                                 style={{background: 'conic-gradient(#f97316 0% 40%, #fbbf24 40% 70%, #3b82f6 70% 90%, #cbd5e1 90% 100%)'}}>
                            </div>
                            <div className="space-y-2 text-sm">
                                <div className="flex items-center gap-2"><div className="w-3 h-3 bg-orange-500 rounded-full"></div> è¨­è¨ˆæ¥­ (40%)</div>
                                <div className="flex items-center gap-2"><div className="w-3 h-3 bg-amber-400 rounded-full"></div> é‹å‹•/å¥åº· (30%)</div>
                                <div className="flex items-center gap-2"><div className="w-3 h-3 bg-blue-500 rounded-full"></div> ç¾æ¥­ (20%)</div>
                                <div className="flex items-center gap-2"><div className="w-3 h-3 bg-slate-300 rounded-full"></div> å…¶ä»– (10%)</div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Detailed Finance List */}
                <div className="bg-white border border-slate-200 rounded-2xl flex-1 overflow-hidden shadow-sm">
                   <div className="p-4 border-b border-slate-100 font-bold text-slate-700 bg-slate-50 flex justify-between items-center">
                        <span>æœ€æ–°å¸³å‹™æ˜ç´°</span>
                        {/* Filters Moved Here */}
                        <div className="flex gap-2">
                            <select 
                                value={financeFilterStatus} 
                                onChange={(e) => setFinanceFilterStatus(e.target.value)}
                                className="bg-white border border-slate-200 text-slate-700 text-xs rounded-lg px-2 py-1 outline-none"
                            >
                                <option value="all">æ‰€æœ‰ç‹€æ…‹</option>
                                <option value="paid">å·²å…¥å¸³</option>
                                <option value="unpaid">è™•ç†ä¸­</option>
                            </select>
                            <select 
                                value={financeFilterDate} 
                                onChange={(e) => setFinanceFilterDate(e.target.value)}
                                className="bg-white border border-slate-200 text-slate-700 text-xs rounded-lg px-2 py-1 outline-none"
                            >
                                <option value="all">æ‰€æœ‰æ™‚é–“</option>
                                <option value="current">æœ¬æœˆ</option>
                                <option value="last">ä¸Šå€‹æœˆ</option>
                            </select>
                        </div>
                   </div>
                   <table className="w-full text-left">
                       <thead className="bg-white border-b border-slate-100 text-xs uppercase text-slate-500">
                           <tr>
                               <th className="p-4">è¨‚å–®ç·¨è™Ÿ</th>
                               <th className="p-4">æ—¥æœŸ</th>
                               <th className="p-4">å®¢æˆ¶</th>
                               <th className="p-4">æ”¯ä»˜æ–¹å¼</th>
                               <th className="p-4">é‡‘é¡</th>
                               <th className="p-4">ç‹€æ…‹</th>
                           </tr>
                       </thead>
                       <tbody className="divide-y divide-slate-50">
                           {filteredFinanceData.length > 0 ? filteredFinanceData.map(apt => (
                               <tr key={apt.id} className="hover:bg-slate-50">
                                   <td className="p-4 text-xs font-mono text-slate-500">#ORD-2025-{1000+apt.id}</td>
                                   <td className="p-4 text-sm text-slate-700">{apt.date}</td>
                                   <td className="p-4 text-sm font-medium">{apt.client}</td>
                                   <td className="p-4 text-sm text-slate-600 flex items-center gap-2">
                                       <CreditCard className="w-3 h-3"/> {apt.method || 'æœªæŒ‡å®š'}
                                   </td>
                                   <td className="p-4 text-sm font-bold">NT$ {apt.amount.toLocaleString()}</td>
                                   <td className="p-4">
                                       <span className={`text-xs px-2 py-1 rounded-full font-bold ${apt.payment === 'paid' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                           {apt.payment === 'paid' ? 'å·²å…¥å¸³' : 'æœªä»˜æ¬¾'}
                                       </span>
                                   </td>
                               </tr>
                           )) : (
                               <tr><td colSpan="6" className="p-8 text-center text-slate-400">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å¸³å‹™è³‡æ–™</td></tr>
                           )}
                       </tbody>
                   </table>
                </div>
            </div>
        )}

        {/* --- OWNER SETUP SURVEY --- */}
        {activeTab === 'owner_setup' && (
          <div className="max-w-3xl mx-auto space-y-6 animate-in fade-in duration-500 py-6">
             <div className="text-center mb-8">
                <div className="w-16 h-16 bg-gradient-to-tr from-orange-400 to-amber-300 rounded-2xl flex items-center justify-center text-white mx-auto mb-4 shadow-lg shadow-orange-200">
                    <Bot className="w-8 h-8" />
                </div>
                <h2 className="text-2xl font-bold text-slate-800">AI åŠ©æ‰‹åˆå§‹è¨­å®š</h2>
                <p className="text-slate-500 mt-2">æ‚¨å¯ä»¥ç›´æ¥ä¸Šå‚³åœ–ç‰‡æˆ–å°è©±ç´€éŒ„ï¼Œè®“æˆ‘è‡ªå‹•å­¸ç¿’æ‚¨çš„ç¶“ç‡Ÿé¢¨æ ¼ã€‚</p>
             </div>

             <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                <div className="p-6 space-y-8">
                   {/* 1. Service Intro */}
                   <div>
                      <div className="flex justify-between items-center mb-2">
                          <label className="text-sm font-bold text-slate-700 flex items-center gap-2">
                             <Info className="w-4 h-4 text-orange-500" /> æœå‹™è©³ç´°ä»‹ç´¹
                          </label>
                      </div>
                      <textarea 
                         className={`w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-200 outline-none text-sm min-h-[100px] ${ownerConfig.service_intro ? 'text-slate-800' : 'text-slate-400'}`}
                         value={ownerConfig.service_intro}
                         onChange={e => setOwnerConfig({...ownerConfig, service_intro: e.target.value})}
                         placeholder="é—œæ–¼æˆ‘å€‘å·¥ä½œå®¤çš„ç‰¹è‰²..."
                      />
                   </div>

                   {/* 2. Services & Prices */}
                   <div>
                      <div className="flex justify-between items-center mb-2">
                          <label className="text-sm font-bold text-slate-700 flex items-center gap-2">
                             <FileText className="w-4 h-4 text-orange-500" /> æœå‹™é …ç›®èˆ‡åƒ¹æ ¼è¡¨
                          </label>
                          <label className="cursor-pointer bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-2 transition-colors">
                              {isAnalyzingImage ? <Loader2 className="w-3 h-3 animate-spin"/> : <ImageIcon className="w-3 h-3"/>}
                              {isAnalyzingImage ? imageAnalysisStep : "ä¸Šå‚³åƒ¹ç›®è¡¨åœ–ç‰‡ (AI è¾¨è­˜)"}
                              <input type="file" className="hidden" onChange={handleImageUpload} accept="image/*" disabled={isAnalyzingImage} />
                          </label>
                      </div>
                      <textarea 
                         className={`w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-200 outline-none text-sm min-h-[100px] transition-all ${ownerConfig.services ? 'text-slate-800' : 'text-slate-400'}`}
                         value={ownerConfig.services}
                         onChange={e => setOwnerConfig({...ownerConfig, services: e.target.value})}
                         placeholder="æ‰‹å‹•è¼¸å…¥æˆ–é»æ“Šä¸Šæ–¹æŒ‰éˆ•ä¸Šå‚³åœ–ç‰‡..."
                      />
                   </div>

                   {/* 3. Rules */}
                   <div>
                      <label className="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                         <Clock className="w-4 h-4 text-orange-500" /> é ç´„èˆ‡å–æ¶ˆè¦å‰‡
                      </label>
                      <textarea 
                         className={`w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-200 outline-none text-sm min-h-[100px] ${ownerConfig.rules ? 'text-slate-800' : 'text-slate-400'}`}
                         value={ownerConfig.rules}
                         onChange={e => setOwnerConfig({...ownerConfig, rules: e.target.value})}
                         placeholder="ä¾‹å¦‚ï¼šéœ€æå‰ 24 å°æ™‚é ç´„..."
                      />
                   </div>

                   {/* 4. QA & Notes */}
                   <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                       <div>
                          <label className="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                             <MessageCircle className="w-4 h-4 text-orange-500" /> å¸¸è¦‹å•ç­”è£œå…… (Q&A)
                          </label>
                          <textarea 
                             className={`w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-200 outline-none text-sm min-h-[100px] ${ownerConfig.qa_supplement ? 'text-slate-800' : 'text-slate-400'}`}
                             value={ownerConfig.qa_supplement}
                             onChange={e => setOwnerConfig({...ownerConfig, qa_supplement: e.target.value})}
                             placeholder="Q: å¯ä»¥å¸¶å¯µç‰©å—? A: å¯ä»¥..."
                          />
                       </div>
                       <div>
                          <label className="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                             <Edit3 className="w-4 h-4 text-orange-500" /> å‚™è¨» (çµ¦ AI çš„å®åš€)
                          </label>
                          <textarea 
                             className={`w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-200 outline-none text-sm min-h-[100px] ${ownerConfig.notes ? 'text-slate-800' : 'text-slate-400'}`}
                             value={ownerConfig.notes}
                             onChange={e => setOwnerConfig({...ownerConfig, notes: e.target.value})}
                             placeholder="ä¾‹å¦‚ï¼šé‡åˆ°æ®ºåƒ¹çš„å®¢äººè«‹å§”å©‰æ‹’çµ•..." 
                          />
                       </div>
                   </div>

                   {/* 5. Tone */}
                   <div>
                      <div className="flex justify-between items-center mb-2">
                          <label className="text-sm font-bold text-slate-700 flex items-center gap-2">
                             <Sparkles className="w-4 h-4 text-orange-500" /> AI å›è¦†èªæ°£åå¥½
                          </label>
                          <label className="cursor-pointer bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-2 transition-colors">
                              {isAnalyzingChat ? <Loader2 className="w-3 h-3 animate-spin"/> : <UploadCloud className="w-3 h-3"/>}
                              {isAnalyzingChat ? "å­¸ç¿’ä¸­..." : "ä¸Šå‚³å°è©±ç´€éŒ„ (AI å­¸ç¿’èªæ°£)"}
                              <input type="file" className="hidden" onChange={handleChatUpload} accept=".txt,.csv,.json" />
                          </label>
                      </div>
                      <div className="grid grid-cols-3 gap-3 mb-3">
                         {['å°ˆæ¥­åš´è¬¹', 'è¦ªåˆ‡ç†±æƒ…', 'å¹½é»˜é¢¨è¶£'].map(t => (
                            <button 
                               key={t}
                               onClick={() => setOwnerConfig({...ownerConfig, tone: t})}
                               className={`py-2 rounded-lg text-sm font-bold border transition-all ${ownerConfig.tone.includes(t) ? 'bg-orange-50 border-orange-500 text-orange-700' : 'bg-white border-slate-200 text-slate-500 hover:bg-slate-50'}`}
                            >
                               {t}
                            </button>
                         ))}
                      </div>
                      <input 
                         type="text" 
                         className={`w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-200 outline-none text-sm ${ownerConfig.tone ? 'text-slate-800' : 'text-slate-400'}`}
                         value={ownerConfig.tone}
                         onChange={e => setOwnerConfig({...ownerConfig, tone: e.target.value})}
                         placeholder="æˆ–è‡ªè¨‚èªæ°£..." 
                      />
                   </div>

                   {/* 6. Links */}
                   <div>
                      <label className="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                         <LinkIcon className="w-4 h-4 text-orange-500" /> ç¤¾ç¾¤/å®˜ç¶²é€£çµ (AI å°‡è‡ªå‹•çˆ¬å–é¢¨æ ¼èˆ‡æ¡ˆä¾‹)
                      </label>
                      <input 
                         type="text" 
                         className={`w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-200 outline-none text-sm ${ownerConfig.links ? 'text-slate-800' : 'text-slate-400'}`}
                         value={ownerConfig.links}
                         onChange={e => setOwnerConfig({...ownerConfig, links: e.target.value})}
                         placeholder="ä¾‹å¦‚ï¼šhttps://instagram.com/my_studio..." 
                      />
                   </div>
                </div>

                <div className="p-6 bg-slate-50 border-t border-slate-100 flex justify-end">
                   <button 
                     onClick={handleSaveConfig}
                     className="bg-slate-900 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-orange-500 hover:shadow-orange-200 transition-all flex items-center gap-2"
                   >
                     <Save className="w-4 h-4" /> å„²å­˜è¨­å®šä¸¦è¨“ç·´ AI
                   </button>
                </div>
             </div>

             {ownerConfig.isSubmitted && (
                <div className="bg-green-50 border border-green-200 rounded-xl p-4 flex items-start gap-3 animate-in fade-in slide-in-from-bottom-2">
                   <CheckCircle className="w-5 h-5 text-green-600 mt-0.5" />
                   <div>
                      <h4 className="font-bold text-green-800">AI è¨“ç·´å®Œæˆï¼</h4>
                      <p className="text-sm text-green-700">ZuZu ç¾åœ¨å·²ç¶“è¨˜ä½äº†æ‚¨çš„æœ€æ–°è¦å‰‡ã€‚æ‚¨å¯ä»¥å›åˆ°ã€Œæ™ºæ…§æ”¶ä»¶åŒ£ã€æ¸¬è©¦æ–°çš„å›æ‡‰æ•ˆæœã€‚</p>
                   </div>
                </div>
             )}
          </div>
        )}

        {/* --- CRM TAB --- */}
        {activeTab === 'crm' && (
          <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden animate-in fade-in duration-300">
             <div className="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center bg-slate-50/50 gap-4">
                 <div>
                    <h2 className="text-xl font-bold text-slate-800">å®¢æˆ¶åå–®</h2>
                    <p className="text-slate-500 text-sm mt-1">å…±æœ‰ {clients.length} ä½æ´»èºå®¢æˆ¶</p>
                 </div>
                 <div className="flex gap-2 flex-wrap">
                    {/* CRM Filters */}
                    <select 
                        value={crmStatusFilter} 
                        onChange={(e) => setCrmStatusFilter(e.target.value)}
                        className="bg-white border border-slate-200 text-slate-700 text-sm rounded-lg px-3 py-2 outline-none focus:border-orange-300"
                    >
                        <option value="all">æ‰€æœ‰ç‹€æ…‹</option>
                        <option value="å·²ç°½ç´„">å·²ç°½ç´„</option>
                        <option value="æ´½è«‡ä¸­">æ´½è«‡ä¸­</option>
                        <option value="æ½›åœ¨">æ½›åœ¨å®¢æˆ¶</option>
                    </select>
                    <select 
                        value={crmSort} 
                        onChange={(e) => setCrmSort(e.target.value)}
                        className="bg-white border border-slate-200 text-slate-700 text-sm rounded-lg px-3 py-2 outline-none focus:border-orange-300"
                    >
                        <option value="recent">æœ€è¿‘äº’å‹•</option>
                        <option value="oldest">æœ€ä¹…æœªäº’å‹•</option>
                    </select>
                    <select 
                        value={crmTagFilter} 
                        onChange={(e) => setCrmTagFilter(e.target.value)}
                        className="bg-white border border-slate-200 text-slate-700 text-sm rounded-lg px-3 py-2 outline-none focus:border-orange-300"
                    >
                        <option value="all">æ‰€æœ‰æ¨™ç±¤</option>
                        {uniqueClientTags.map(tag => <option key={tag} value={tag}>{tag}</option>)}
                    </select>
                    <button className="flex items-center gap-2 px-3 py-2 bg-slate-900 text-white rounded-lg text-sm font-bold hover:bg-slate-800">
                       <Users className="w-4 h-4" /> æ–°å¢å®¢æˆ¶
                    </button>
                 </div>
             </div>
             <table className="w-full text-left">
                <thead className="bg-slate-50 text-slate-500 text-xs uppercase border-b border-slate-100">
                   <tr>
                      <th className="p-4 pl-6 font-semibold">å®¢æˆ¶è³‡æ–™</th>
                      <th className="p-4 font-semibold">æ¨™ç±¤</th>
                      <th className="p-4 font-semibold">ç‹€æ…‹</th>
                      <th className="p-4 font-semibold">ä¸Šæ¬¡äº’å‹•</th>
                      <th className="p-4 font-semibold">ç´¯è¨ˆæ¶ˆè²»</th>
                      <th className="p-4 font-semibold text-right pr-6">æ“ä½œ</th>
                   </tr>
                </thead>
                <tbody className="divide-y divide-slate-50">
                   {filteredClients.map(c => (
                      <tr key={c.id} className="group hover:bg-slate-50 transition-colors cursor-pointer" onClick={() => handleViewClientDetail(c)}>
                         <td className="p-4 pl-6">
                            <div className="flex items-center gap-3">
                               <div className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-sm font-bold text-slate-600 border border-slate-200">
                                  {c.name[0]}
                               </div>
                               <div>
                                  <div className="font-bold text-slate-800">{c.name}</div>
                                  <div className="text-xs text-slate-400 flex items-center gap-1">
                                     {c.source.includes('LINE') ? <div className="w-2 h-2 rounded-full bg-green-500"></div> : <div className="w-2 h-2 rounded-full bg-slate-300"></div>}
                                     {c.source}
                                  </div>
                               </div>
                            </div>
                         </td>
                         <td className="p-4">
                            <div className="flex flex-wrap gap-1">
                               {c.tags.map(tag => (
                                  <span key={tag} className="bg-white border border-slate-200 px-2 py-0.5 rounded text-[10px] text-slate-500">{tag}</span>
                               ))}
                            </div>
                         </td>
                         <td className="p-4">
                            <span className={`px-2 py-1 rounded-full text-xs font-bold ${c.status === 'å·²ç°½ç´„' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-600'}`}>
                               {c.status}
                            </span>
                         </td>
                         <td className="p-4 text-sm text-slate-500">{c.lastContact}</td>
                         <td className="p-4 text-sm font-bold text-slate-700">NT$ {c.totalSpent.toLocaleString()}</td>
                         <td className="p-4 pr-6 text-right">
                            <div className="flex justify-end gap-2">
                               <button 
                                 onClick={(e) => { e.stopPropagation(); handleJumpToChat(c.name); }}
                                 className="p-2 text-slate-500 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-colors tooltip bg-white border border-slate-100"
                                 title="ç™¼é€è¨Šæ¯"
                               >
                                  <MessageCircle className="w-4 h-4" />
                               </button>
                               <button 
                                 onClick={() => handleViewClientDetail(c)}
                                 className="p-2 text-slate-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors bg-white border border-slate-100" title="æŸ¥çœ‹è©³æƒ…"
                               >
                                  <ArrowUpRight className="w-4 h-4" />
                               </button>
                            </div>
                         </td>
                      </tr>
                   ))}
                </tbody>
             </table>
             
             {/* Pagination Placeholder */}
             <div className="p-4 border-t border-slate-100 flex justify-center">
                <button className="text-xs text-slate-400 font-medium hover:text-slate-600">è¼‰å…¥æ›´å¤š...</button>
             </div>
          </div>
        )}

      </main>

      {/* --- MODALS --- */}
      
      {/* Article Modal */}
      {showArticleModal && (
        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex justify-center items-center animate-in fade-in duration-200" onClick={() => setShowArticleModal(null)}>
            <div className="bg-white rounded-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto m-4 shadow-2xl" onClick={e => e.stopPropagation()}>
                <div className="p-6 border-b border-slate-100 flex justify-between items-start sticky top-0 bg-white z-10">
                    <div>
                        <span className="text-xs font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded mb-2 inline-block">{showArticleModal.source}</span>
                        <h2 className="text-xl font-bold text-slate-800">{showArticleModal.title}</h2>
                        <div className="text-xs text-slate-400 mt-1">{showArticleModal.date}</div>
                    </div>
                    <button onClick={() => setShowArticleModal(null)} className="p-2 hover:bg-slate-100 rounded-full text-slate-400">
                        <X className="w-5 h-5" />
                    </button>
                </div>
                <div className="p-8 text-slate-600 leading-relaxed whitespace-pre-wrap">
                    {showArticleModal.content}
                </div>
                <div className="p-6 border-t border-slate-100 flex justify-end gap-3 sticky bottom-0 bg-white">
                    <a href={showArticleModal.url} target="_blank" rel="noopener noreferrer" className="px-4 py-2 border border-slate-200 text-slate-600 font-bold hover:bg-slate-50 rounded-lg flex items-center gap-2">
                        <ExternalLink className="w-4 h-4" /> å‰å¾€åŸå§‹ç¶²é 
                    </a>
                    <button onClick={() => setShowArticleModal(null)} className="px-4 py-2 text-slate-500 font-bold hover:bg-slate-50 rounded-lg">é—œé–‰</button>
                    <button onClick={() => {setShowArticleModal(null); handleGeneratePost(showArticleModal, 'trends');}} className="px-6 py-2 bg-slate-900 text-white font-bold rounded-lg hover:bg-slate-800 flex items-center gap-2">
                        <Sparkles className="w-4 h-4" /> ç”Ÿæˆè²¼æ–‡
                    </button>
                </div>
            </div>
        </div>
      )}

      {/* Re-engagement Modal */}
      {showReengagementModal && (
        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex justify-center items-center animate-in fade-in duration-200" onClick={() => setShowReengagementModal(null)}>
            <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
                <div className="p-6 border-b border-slate-100 flex justify-between items-center">
                    <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <Sparkles className="w-5 h-5 text-orange-500" /> AI å–šé†’è¨Šæ¯ç”Ÿæˆ
                    </h3>
                    <button onClick={() => setShowReengagementModal(null)} className="text-slate-400 hover:text-slate-600">
                        <X className="w-5 h-5" />
                    </button>
                </div>
                <div className="p-6">
                    <div className="mb-4">
                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">ç›®æ¨™å®¢æˆ¶</label>
                        <div className="text-slate-800 font-bold">{showReengagementModal.name}</div>
                    </div>
                    <div className="bg-orange-50 border border-orange-100 rounded-xl p-4">
                        <textarea 
                            className="w-full bg-transparent border-none outline-none text-slate-700 text-sm resize-none h-32"
                            value={generatedReengagementMsg}
                            onChange={(e) => setGeneratedReengagementMsg(e.target.value)}
                        />
                    </div>
                </div>
                <div className="p-6 border-t border-slate-100 flex justify-end gap-3">
                    <button onClick={() => setShowReengagementModal(null)} className="px-4 py-2 text-slate-500 font-bold hover:bg-slate-50 rounded-lg">å–æ¶ˆ</button>
                    <button onClick={() => {
                        setShowReengagementModal(null); 
                        handleJumpToChat(showReengagementModal.name);
                        setTimeout(() => setManualInput(generatedReengagementMsg), 500);
                    }} className="px-6 py-2 bg-slate-900 text-white font-bold rounded-lg hover:bg-slate-800 flex items-center gap-2">
                        <MessageCircle className="w-4 h-4" /> å‰å¾€ç™¼é€
                    </button>
                </div>
            </div>
        </div>
      )}

      {/* Settings Modal */}
      {showSettingsModal && (
        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex justify-center items-center animate-in fade-in duration-200" onClick={() => setShowSettingsModal(false)}>
            <div className="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
                <div className="p-6 bg-gradient-to-r from-slate-900 to-slate-800 text-white">
                    <div className="flex justify-between items-start">
                        <div className="flex items-center gap-4">
                            <div className="w-16 h-16 rounded-full bg-white/20 border-2 border-white/30 overflow-hidden">
                                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Annie" alt="User" />
                            </div>
                            <div>
                                <h3 className="text-xl font-bold">YUJUN</h3>
                                <p className="text-sm opacity-80">Pro å°ˆæ¥­ç‰ˆæ–¹æ¡ˆ</p>
                            </div>
                        </div>
                        <button onClick={() => setShowSettingsModal(false)} className="text-white/60 hover:text-white">
                            <X className="w-6 h-6" />
                        </button>
                    </div>
                </div>
                <div className="p-6 space-y-6">
                    {/* Subscription Info */}
                    <div className="space-y-4">
                        <h4 className="text-sm font-bold text-slate-400 uppercase tracking-wider">è¨‚é–±è³‡è¨Š</h4>
                        <div className="flex justify-between items-center py-2 border-b border-slate-50">
                            <span className="text-slate-600 font-medium">ç›®å‰æ–¹æ¡ˆ</span>
                            <span className="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold">Pro å°ˆæ¥­ç‰ˆ</span>
                        </div>
                        <div className="flex justify-between items-center py-2 border-b border-slate-50">
                            <span className="text-slate-600 font-medium">ä¸‹æ¬¡æ‰£æ¬¾æ—¥</span>
                            <span className="text-slate-800 font-bold">2025/12/14</span>
                        </div>
                        <div className="flex justify-between items-center py-2 border-b border-slate-50">
                            <span className="text-slate-600 font-medium">æ‰£æ¬¾é‡‘é¡</span>
                            <span className="text-slate-800 font-bold">NT$ 3,000</span>
                        </div>
                    </div>

                    {/* History */}
                    <div className="space-y-4">
                        <h4 className="text-sm font-bold text-slate-400 uppercase tracking-wider">æœ€è¿‘æ‰£æ¬¾ç´€éŒ„</h4>
                        <div className="space-y-2">
                            <div className="flex justify-between text-sm">
                                <span className="text-slate-600">2025/11/14</span>
                                <span className="text-slate-800 font-bold">- NT$ 3,000</span>
                            </div>
                            <div className="flex justify-between text-sm">
                                <span className="text-slate-600">2025/10/14</span>
                                <span className="text-slate-800 font-bold">- NT$ 3,000</span>
                            </div>
                        </div>
                    </div>

                    <button className="w-full py-3 rounded-xl border border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition-colors">
                        ç®¡ç†è¨‚é–±èˆ‡ä»˜æ¬¾æ–¹å¼
                    </button>
                </div>
            </div>
        </div>
      )}
      
      {/* Client Detail & Edit Modal (UPDATED) */}
      {showClientModal && (
        <div className="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-50 flex justify-end animate-in fade-in duration-200" onClick={() => setShowClientModal(null)}>
          <div className="w-full md:w-[480px] bg-white h-full shadow-2xl p-6 overflow-y-auto animate-in slide-in-from-right duration-300" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-start mb-6">
              <div className="flex gap-4 items-center">
                <div className="w-16 h-16 rounded-full bg-orange-100 flex items-center justify-center text-2xl font-bold text-orange-600">
                  {showClientModal.name[0]}
                </div>
                <div>
                  {isEditingClient ? (
                     <input 
                        className="text-2xl font-bold text-slate-800 border-b border-slate-300 focus:border-orange-500 outline-none bg-transparent w-full"
                        value={editingClientData.name}
                        onChange={(e) => setEditingClientData({...editingClientData, name: e.target.value})}
                     />
                  ) : (
                     <h2 className="text-2xl font-bold text-slate-800">{showClientModal.name}</h2>
                  )}
                  
                  {isEditingClient ? (
                     <input 
                        className="text-slate-500 font-medium border-b border-slate-300 focus:border-orange-500 outline-none bg-transparent w-full mt-1 text-sm"
                        value={editingClientData.company}
                        onChange={(e) => setEditingClientData({...editingClientData, company: e.target.value})}
                        placeholder="å…¬å¸åç¨±"
                     />
                  ) : (
                     <p className="text-slate-500 font-medium">{showClientModal.company}</p>
                  )}
                  
                  {!isEditingClient && (
                    <div className="flex items-center gap-2 mt-2">
                        <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${showClientModal.status === 'å·²ç°½ç´„' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>
                        {showClientModal.status}
                        </span>
                        <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-slate-100 text-slate-600">
                        {showClientModal.industry || 'æœªåˆ†é¡'}
                        </span>
                    </div>
                  )}
                </div>
              </div>
              <div className="flex gap-2">
                 {isEditingClient ? (
                    <button onClick={handleSaveClientData} className="p-2 bg-green-500 text-white rounded-full hover:bg-green-600 shadow-md">
                        <Save className="w-5 h-5" />
                    </button>
                 ) : (
                    <button onClick={() => setIsEditingClient(true)} className="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-orange-500">
                        <Edit3 className="w-5 h-5" />
                    </button>
                 )}
                 <button onClick={() => setShowClientModal(null)} className="p-2 hover:bg-slate-100 rounded-full text-slate-400">
                   <X className="w-6 h-6" />
                 </button>
              </div>
            </div>

            <div className="space-y-6">
              {/* Stats */}
              <div className="grid grid-cols-2 gap-4">
                  <div className="bg-slate-50 p-4 rounded-xl text-center">
                      <div className="text-xs text-slate-500 mb-1">ç´¯è¨ˆæ¶ˆè²»</div>
                      <div className="text-lg font-bold text-slate-800">NT$ {showClientModal.totalSpent.toLocaleString()}</div>
                  </div>
                  <div className="bg-slate-50 p-4 rounded-xl text-center">
                      <div className="text-xs text-slate-500 mb-1">äº’å‹•æ¬¡æ•¸</div>
                      <div className="text-lg font-bold text-slate-800">{showClientModal.visits} æ¬¡</div>
                  </div>
              </div>

              {/* Contact Info (Editable) */}
              <div className="bg-white border border-slate-100 rounded-xl p-4 space-y-3">
                <div className="flex items-center gap-3 text-slate-600">
                  <Phone className="w-4 h-4" />
                  {isEditingClient ? (
                      <input className="border-b border-slate-200 outline-none focus:border-orange-500 flex-1" value={editingClientData.phone} onChange={(e) => setEditingClientData({...editingClientData, phone: e.target.value})} />
                  ) : <span>{showClientModal.phone}</span>}
                </div>
                <div className="flex items-center gap-3 text-slate-600">
                  <Mail className="w-4 h-4" />
                  {isEditingClient ? (
                      <input className="border-b border-slate-200 outline-none focus:border-orange-500 flex-1" value={editingClientData.email} onChange={(e) => setEditingClientData({...editingClientData, email: e.target.value})} />
                  ) : <span>{showClientModal.email}</span>}
                </div>
                <div className="flex items-center gap-3 text-slate-600">
                  <Globe className="w-4 h-4" />
                  <span>ä¾†æºï¼š{showClientModal.source}</span>
                </div>
                
                {isEditingClient && (
                    <div className="grid grid-cols-2 gap-4 mt-2">
                         <div>
                             <label className="text-[10px] uppercase font-bold text-slate-400">ç‹€æ…‹</label>
                             <select className="w-full border-b border-slate-200 outline-none text-sm py-1 bg-transparent" value={editingClientData.status} onChange={(e) => setEditingClientData({...editingClientData, status: e.target.value})}>
                                 <option>å·²ç°½ç´„</option>
                                 <option>æ´½è«‡ä¸­</option>
                                 <option>æ½›åœ¨</option>
                             </select>
                         </div>
                         <div>
                             <label className="text-[10px] uppercase font-bold text-slate-400">ç”¢æ¥­</label>
                             <select className="w-full border-b border-slate-200 outline-none text-sm py-1 bg-transparent" value={editingClientData.industry} onChange={(e) => setEditingClientData({...editingClientData, industry: e.target.value})}>
                                 <option>è¨­è¨ˆ</option>
                                 <option>ç¾æ¥­</option>
                                 <option>é‹å‹•/å¥åº·</option>
                                 <option>åª’é«”</option>
                                 <option>å…¶ä»–</option>
                             </select>
                         </div>
                    </div>
                )}
              </div>

              {/* Tags (Simple View for now) */}
              <div>
                <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2 text-sm">
                  <Users className="w-4 h-4" /> å®¢æˆ¶æ¨™ç±¤
                </h3>
                <div className="flex flex-wrap gap-2">
                    {showClientModal.tags.map(tag => (
                        <span key={tag} className="px-3 py-1 bg-white border border-slate-200 rounded-lg text-sm text-slate-600">
                            {tag}
                        </span>
                    ))}
                    {isEditingClient && <button className="px-3 py-1 bg-slate-100 border border-dashed border-slate-300 rounded-lg text-sm text-slate-400 hover:text-slate-600">+ æ–°å¢</button>}
                </div>
              </div>

              {/* Notes (Editable) */}
              <div>
                <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2 text-sm">
                  <Edit3 className="w-4 h-4" /> å‚™è¨»ç­†è¨˜
                </h3>
                {isEditingClient ? (
                    <textarea 
                        className="w-full h-24 p-2 border border-slate-200 rounded-xl outline-none focus:border-orange-500 bg-yellow-50/50 text-sm"
                        value={editingClientData.notes}
                        onChange={(e) => setEditingClientData({...editingClientData, notes: e.target.value})}
                    />
                ) : (
                    <div className="bg-yellow-50 border border-yellow-100 rounded-xl p-4 text-slate-700 text-sm leading-relaxed">
                        {showClientModal.notes}
                    </div>
                )}
              </div>

              {!isEditingClient && (
                <div className="pt-4 border-t border-slate-100">
                    <button 
                        onClick={() => handleJumpToChat(showClientModal.name)}
                        className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-slate-800 flex items-center justify-center gap-2"
                    >
                        <MessageCircle className="w-4 h-4" /> ç™¼é€è¨Šæ¯
                    </button>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Notification Toast */}
      {notification && (
        <div className="fixed bottom-6 right-6 bg-slate-900 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 animate-in slide-in-from-bottom-5 fade-in duration-300 z-50 border border-slate-700">
          <CheckCircle className="w-5 h-5 text-green-400" />
          <span className="font-medium text-sm">{notification}</span>
        </div>
      )}
    </div>
  );
}

// Helper Components
const SidebarItem = ({ icon: Icon, label, active, onClick, alertCount }) => (
  <button
    onClick={onClick}
    className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 ${
      active 
        ? 'bg-orange-500 text-white shadow-lg shadow-orange-200' 
        : 'text-slate-500 hover:bg-orange-50 hover:text-orange-600'
    }`}
  >
    <Icon className="w-5 h-5" />
    <span className="font-medium">{label}</span>
    {alertCount > 0 && (
      <span className={`ml-auto text-xs font-bold px-2 py-0.5 rounded-full ${active ? 'bg-white text-orange-500' : 'bg-orange-100 text-orange-600'}`}>
        {alertCount}
      </span>
    )}
  </button>
);

const IntegrationCard = ({ name, icon: Icon, status, color, desc }) => (
    <div className="bg-white border border-slate-200 rounded-2xl p-6 flex flex-col justify-between h-40 hover:shadow-md transition-shadow">
        <div className="flex justify-between items-start">
            <div className={`p-3 rounded-xl bg-slate-50 ${color}`}>
                <Icon className="w-6 h-6" />
            </div>
            <div className={`flex items-center gap-1.5 text-xs font-bold px-2 py-1 rounded-full ${status === 'connected' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'}`}>
                <div className={`w-2 h-2 rounded-full ${status === 'connected' ? 'bg-green-500' : 'bg-slate-400'}`}></div>
                {status === 'connected' ? 'å·²é€£ç·š' : 'æœªé€£ç·š'}
            </div>
        </div>
        <div>
            <h3 className="font-bold text-slate-800">{name}</h3>
            <p className="text-xs text-slate-500 mt-1">{desc}</p>
        </div>
    </div>
);

const StatCard = ({ title, value, icon: Icon, color }) => (
  <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
     <div className={`p-4 rounded-xl ${color}`}>
        <Icon className="w-6 h-6" />
     </div>
     <div>
        <h3 className="text-slate-500 text-sm font-medium">{title}</h3>
        <div className="text-2xl font-bold text-slate-800">{value}</div>
     </div>
  </div>
);
