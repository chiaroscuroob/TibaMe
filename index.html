<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Product Scene Generator Pro (v7.7 Stable)</title>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #e4e4e7; border-radius: 20px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #d4d4d8; }
        .bg-grid-pattern { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin 3s linear infinite; }
    </style>
</head>
<body class="bg-zinc-50 text-zinc-900 h-screen flex flex-col overflow-hidden selection:bg-zinc-900 selection:text-white">

    <!-- Header -->
    <header class="bg-white border-b border-zinc-200 h-16 flex-none z-30">
        <div class="max-w-[1600px] mx-auto px-6 h-full flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-zinc-900 rounded flex items-center justify-center text-white">
                    <i data-lucide="aperture" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-lg tracking-tight">StudioAI <span class="font-normal text-zinc-400">| Pro</span></span>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-xs font-medium text-zinc-400 border px-2 py-1 rounded border-zinc-200 bg-zinc-50">v7.7 All-in-One</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-[1600px] mx-auto p-6 flex-1 w-full overflow-hidden">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 h-full">
            
            <!-- Left Panel -->
            <div class="lg:col-span-4 flex flex-col gap-6 overflow-y-auto pr-2 custom-scrollbar h-full pb-20">
                
                <!-- 1. Product Image -->
                <section class="space-y-2">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xs font-bold text-zinc-900 uppercase tracking-wider flex items-center gap-2">
                            <span class="w-5 h-5 rounded-full bg-zinc-900 text-white flex items-center justify-center text-[10px]">1</span>
                            商品原圖 (Product)
                        </h2>
                        <button id="clear-product-btn" class="text-[10px] text-zinc-400 hover:text-red-600 transition-colors hidden">清除</button>
                    </div>
                    <!-- 回復使用 JS 監聽點擊的方法，這在各種瀏覽器中最穩定 -->
                    <div id="product-upload-area" class="border border-dashed border-zinc-300 rounded-xl bg-white hover:bg-zinc-50 transition-all cursor-pointer h-32 flex flex-col items-center justify-center gap-2 group relative">
                        <input type="file" id="product-input" class="hidden" accept="image/*">
                        
                        <div id="product-placeholder" class="flex flex-col items-center gap-2 pointer-events-none">
                            <i data-lucide="upload" class="w-6 h-6 text-zinc-400 group-hover:text-zinc-600 transition-colors"></i>
                            <span class="text-xs text-zinc-500 font-medium">上傳商品 (去背或白底佳)</span>
                        </div>
                        <div id="product-preview-container" class="absolute inset-0 w-full h-full hidden bg-white rounded-xl overflow-hidden border border-zinc-200 pointer-events-none">
                            <img id="product-img" class="w-full h-full object-contain p-2 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
                            <div id="product-analysis-overlay" class="absolute inset-0 bg-white/80 flex items-center justify-center hidden">
                                <div class="flex items-center gap-2 text-zinc-600 text-xs animate-pulse"><i data-lucide="scan-eye" class="w-4 h-4"></i> 正在辨識商品...</div>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2 px-1">
                            <i data-lucide="tag" class="w-3 h-3 text-zinc-400"></i>
                            <input type="text" id="product-name" placeholder="這是什麼？(例如: 滷肉飯, 洗髮精)" class="flex-1 text-xs bg-transparent border-b border-zinc-200 focus:border-zinc-800 outline-none py-1 placeholder:text-zinc-300 font-medium text-zinc-800">
                        </div>
                        <div id="product-suggestions" class="flex flex-wrap gap-1.5 px-1"></div>
                    </div>
                </section>

                <!-- 2. Background Source -->
                <section class="space-y-3 pt-2 border-t border-zinc-100">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xs font-bold text-zinc-900 uppercase tracking-wider flex items-center gap-2">
                            <span class="w-5 h-5 rounded-full bg-zinc-900 text-white flex items-center justify-center text-[10px]">2</span>
                            背景來源設定 (Background)
                        </h2>
                    </div>
                    <div class="flex p-1 bg-zinc-100 rounded-lg">
                        <button id="mode-upload-btn" class="flex-1 flex items-center justify-center gap-2 py-2 rounded-md text-xs font-medium transition-all bg-white text-zinc-900 shadow-sm"><i data-lucide="image-plus" class="w-3 h-3"></i> 自訂圖片上傳</button>
                        <button id="mode-preset-btn" class="flex-1 flex items-center justify-center gap-2 py-2 rounded-md text-xs font-medium transition-all text-zinc-500 hover:text-zinc-700"><i data-lucide="layout" class="w-3 h-3"></i> AI 風格預設</button>
                    </div>

                    <div id="upload-mode-content" class="space-y-3">
                        <!-- 回復使用 JS 監聽點擊的方法 -->
                        <div id="ref-upload-area" class="border border-dashed border-zinc-300 rounded-xl bg-white hover:bg-zinc-50 transition-all cursor-pointer h-32 flex flex-col items-center justify-center gap-1 group relative">
                             <input type="file" id="ref-input" class="hidden" accept="image/*">
                             
                             <div id="ref-placeholder" class="flex flex-col items-center gap-1 pointer-events-none">
                                <i data-lucide="store" class="w-6 h-6 text-zinc-400 group-hover:text-zinc-600 transition-colors"></i>
                                <span class="text-xs text-zinc-500 font-medium">上傳參考圖片 (店景/風格圖)</span>
                             </div>
                             <div id="ref-preview-container" class="absolute inset-0 w-full h-full hidden bg-white rounded-xl overflow-hidden border border-zinc-300 pointer-events-none">
                                <img id="ref-img" class="w-full h-full object-contain p-1 bg-zinc-50">
                                <div class="absolute top-1 right-1 bg-zinc-900/70 text-white text-[10px] px-1.5 rounded">已上傳</div>
                             </div>
                             <button id="clear-ref-btn" class="absolute bottom-1 right-1 text-[10px] bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 transition-colors z-30 hidden">移除</button>
                        </div>
                        
                        <div id="upload-submode-container" class="bg-indigo-50 border border-indigo-100 p-2 rounded-lg hidden">
                            <label class="text-[10px] font-bold text-indigo-900 uppercase tracking-wider mb-1.5 block">此圖片用途 (Usage)</label>
                            <div class="flex gap-1">
                                <button id="submode-composite-btn" class="flex-1 flex flex-col items-center justify-center gap-1 py-2 px-1 rounded-md text-[10px] font-medium transition-all border bg-indigo-600 text-white border-indigo-600 shadow-sm">
                                    <div class="flex items-center gap-1"><i data-lucide="stamp" class="w-3 h-3"></i> 背景圖</div>
                                    <span class="text-[9px] opacity-80 font-normal scale-90">保留結構・直接合成</span>
                                </button>
                                <button id="submode-composition-btn" class="flex-1 flex flex-col items-center justify-center gap-1 py-2 px-1 rounded-md text-[10px] font-medium transition-all border bg-white text-zinc-500 border-zinc-200 hover:border-indigo-300">
                                    <div class="flex items-center gap-1"><i data-lucide="frame" class="w-3 h-3"></i> 參考構圖</div>
                                    <span class="text-[9px] opacity-80 font-normal scale-90">替換主體・模仿構圖</span>
                                </button>
                            </div>
                            <p id="submode-desc" class="text-[10px] text-indigo-800/70 mt-1.5 px-1 leading-tight">• 適合空景照片。AI 會保留照片中的桌子/空間，直接把商品放進去。</p>
                        </div>
                    </div>

                    <div id="preset-mode-content" class="grid grid-cols-2 gap-2 hidden"></div>
                </section>

                <!-- 3. Generate -->
                <div class="mt-auto space-y-4 pt-4 border-t border-zinc-200">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-zinc-400 uppercase tracking-wider ml-1">補充提示詞 (Optional)</label>
                        <textarea id="custom-prompt" placeholder="例如: 增加一點桌面反光..." class="w-full p-3 text-sm border rounded-xl focus:ring-1 focus:ring-zinc-900 outline-none h-16 bg-white border-zinc-200 resize-none"></textarea>
                    </div>
                    <button id="generate-btn" disabled class="w-full h-12 rounded-xl font-bold text-base flex items-center justify-center gap-2 transition-all shadow-lg transform active:scale-[0.98] bg-zinc-100 text-zinc-400 cursor-not-allowed">
                        <i data-lucide="rocket" class="w-4 h-4"></i><span id="generate-btn-text">生成預設場景 + 4視角</span>
                    </button>
                    <div id="error-msg" class="text-red-500 text-xs text-center hidden"></div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="lg:col-span-8 flex flex-col gap-6 h-full overflow-y-auto custom-scrollbar pb-6">
                <div class="bg-zinc-100 rounded-2xl border border-zinc-200 overflow-hidden relative shadow-inner flex flex-col w-full h-auto min-h-[400px] shrink-0 transition-all group">
                    <div class="h-12 bg-white border-b border-zinc-200 flex items-center justify-between px-4 sticky top-0 z-10 shrink-0">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-zinc-800 uppercase tracking-wider flex items-center gap-1"><i data-lucide="sparkles" class="w-3 h-3 text-amber-500"></i><span id="preview-title">AI Preview</span></span>
                        </div>
                        <div class="flex gap-2">
                            <button id="download-main-btn" class="flex items-center gap-1 px-3 py-1 bg-zinc-900 text-white text-xs rounded hover:bg-zinc-800 hidden"><i data-lucide="download" class="w-3 h-3"></i> 下載</button>
                        </div>
                    </div>
                    <div class="flex-1 relative flex items-center justify-center p-4 bg-zinc-50/50 overflow-hidden min-h-[400px]">
                        <div class="absolute inset-0 opacity-[0.5] pointer-events-none bg-grid-pattern"></div>
                        <div id="preview-empty" class="text-center text-zinc-400 relative z-10">
                            <div class="w-16 h-16 bg-zinc-100 rounded-full flex items-center justify-center mx-auto mb-3 border border-zinc-200"><i data-lucide="monitor" class="w-6 h-6 text-zinc-300"></i></div>
                            <p class="text-sm font-medium">準備就緒</p><p class="text-xs mt-1 text-zinc-400">等待指令中...</p>
                        </div>
                        <div id="preview-loading" class="flex flex-col items-center justify-center text-zinc-500 gap-3 relative z-10 hidden">
                            <div class="w-12 h-12 border-4 border-zinc-300 border-t-zinc-900 rounded-full animate-spin"></div>
                            <div class="text-center"><p class="text-sm font-bold text-zinc-800">正在生成中...</p><p class="text-xs text-zinc-400 mt-1">AI 正在計算光影與透視</p></div>
                        </div>
                        <img id="main-result-img" class="w-auto h-auto max-w-full max-h-full object-contain shadow-2xl rounded-lg bg-white hidden relative z-10">
                    </div>
                </div>
                <div id="variations-section" class="space-y-3 pb-10 hidden">
                    <h3 class="text-sm font-bold text-zinc-700 flex items-center gap-2 px-1"><i data-lucide="grid" class="w-4 h-4"></i> 多視角變體 (Variations)</h3>
                    <div id="variations-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ================= CONFIG =================
        const API_KEY = "AIzaSyC6Bqdd4k4h_8yTmdGO9S9qWp_rz8DDPv8"; // ★請確認 API Key★

        const state = {
            productImage: null,
            refImage: null,
            productName: "",
            bgSourceMode: 'upload',
            uploadSubMode: 'composite',
            selectedPreset: 0,
            customPrompt: "",
            isLoading: false,
            isAnalyzing: false,
            generatedImage: null,
            variations: []
        };

        const SCENE_PRESETS = [
            { name: '極簡攝影棚', desc: '純淨光影，專業打光', icon: 'camera', prompt: "Professional studio photography. Clean, minimal white or light grey background. Soft diffused lighting from above. Sharp focus, 8k resolution, highly detailed texture." },
            { name: '溫暖木質', desc: '居家氛圍，自然窗光', icon: 'box', prompt: "Beautiful light oak wooden surface. Warm natural sunlight streaming from a window. Sharp product focus with creamy bokeh background. Cozy home atmosphere." },
            { name: '奢華大理石', desc: '高級冷調，表面反光', icon: 'layout', prompt: "Luxurious white marble countertop. Elegant setting. Bright, crisp soft lighting. Realistic reflections on the surface. Premium lifestyle vibe." },
            { name: '現代咖啡廳', desc: '時尚散景，悠閒感', icon: 'coffee', prompt: "Stylish wooden table in a modern cafe. Blurred bokeh lights in background. Warm inviting atmosphere. Photorealistic food photography style." },
            { name: '鄉村廚房', desc: '手作感，亞麻與香草', icon: 'utensils', prompt: "Rustic wooden cutting board in a cozy farmhouse kitchen. Soft natural window light. Linen and herbs props. High texture detail." },
            { name: '戶外花園', desc: '清新自然，明亮陽光', icon: 'leaf', prompt: "Picnic blanket in a sunny garden. Blurred greenery background. Bright natural sunlight. Fresh atmosphere. Sharp details." }
        ];

        const VARIATION_ANGLES = [
            { label: "完全俯視 (Flat Lay)", instruction: "STRICT 90° OVERHEAD VIEW (ORTHOGRAPHIC). \nCRITICAL RULE: ELIMINATE ALL PERSPECTIVE DEPTH. Do not create a room or horizon. Treat the reference image's ground (e.g. sand, wood) as a FLAT 2D TEXTURE PATTERN (like a wallpaper or texture scan). The product must lay flat on this infinite texture. NO VANISHING POINT." },
            { label: "平視 (Eye Level)", instruction: "STRAIGHT-ON EYE-LEVEL VIEW (0°). Lower the camera to the product's base height. The background surface should look like a flat horizontal line supporting the product. Perfect horizon alignment." },
            { label: "45度側拍 (Classic)", instruction: "NATURAL 45° PRODUCT ANGLE. Ensure REALISTIC SCALE and DEPTH. Show the surface receding into the distance behind the product. Standard e-commerce perspective with sharp focus." },
            { label: "側面特寫 (Detail)", instruction: "CLOSE-UP SIDE PROFILE (Detail Shot). Zoom in on the product. Use a SHALLOW DEPTH OF FIELD (f/2.8) to significantly BLUR the background into soft bokeh. Focus strictly on the product's texture and details." }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const els = {
                productInput: document.getElementById('product-input'),
                productUploadArea: document.getElementById('product-upload-area'),
                productPlaceholder: document.getElementById('product-placeholder'),
                productPreviewContainer: document.getElementById('product-preview-container'),
                productImg: document.getElementById('product-img'),
                productAnalysisOverlay: document.getElementById('product-analysis-overlay'),
                clearProductBtn: document.getElementById('clear-product-btn'),
                productName: document.getElementById('product-name'),
                productSuggestions: document.getElementById('product-suggestions'),
                
                modeUploadBtn: document.getElementById('mode-upload-btn'),
                modePresetBtn: document.getElementById('mode-preset-btn'),
                uploadModeContent: document.getElementById('upload-mode-content'),
                presetModeContent: document.getElementById('preset-mode-content'),
                
                refInput: document.getElementById('ref-input'),
                refUploadArea: document.getElementById('ref-upload-area'),
                refPlaceholder: document.getElementById('ref-placeholder'),
                refPreviewContainer: document.getElementById('ref-preview-container'),
                refImg: document.getElementById('ref-img'),
                clearRefBtn: document.getElementById('clear-ref-btn'),
                
                uploadSubmodeContainer: document.getElementById('upload-submode-container'),
                submodeCompositeBtn: document.getElementById('submode-composite-btn'),
                submodeCompositionBtn: document.getElementById('submode-composition-btn'),
                submodeDesc: document.getElementById('submode-desc'),
                
                customPrompt: document.getElementById('custom-prompt'),
                generateBtn: document.getElementById('generate-btn'),
                generateBtnText: document.getElementById('generate-btn-text'),
                errorMsg: document.getElementById('error-msg'),
                
                previewEmpty: document.getElementById('preview-empty'),
                previewLoading: document.getElementById('preview-loading'),
                mainResultImg: document.getElementById('main-result-img'),
                previewTitle: document.getElementById('preview-title'),
                downloadMainBtn: document.getElementById('download-main-btn'),
                
                variationsSection: document.getElementById('variations-section'),
                variationsGrid: document.getElementById('variations-grid')
            };

            function init() {
                renderPresets();
                updateUI();
                if (window.lucide) window.lucide.createIcons();
            }

            // ================= EVENT LISTENERS (確保這裡綁定正確) =================
            
            // 1. 商品上傳
            els.productUploadArea.addEventListener('click', () => els.productInput.click());
            els.productInput.addEventListener('change', (e) => handleFile(e, 'product'));
            els.clearProductBtn.addEventListener('click', (e) => { e.stopPropagation(); clearFile('product'); });
            els.productName.addEventListener('input', (e) => { state.productName = e.target.value; });

            // 2. 參考圖上傳 (★關鍵：這裡必須有監聽器★)
            els.refUploadArea.addEventListener('click', () => {
                console.log("Ref Upload Clicked"); // 除錯用
                els.refInput.click();
            });
            els.refInput.addEventListener('change', (e) => handleFile(e, 'ref'));
            els.clearRefBtn.addEventListener('click', (e) => { e.stopPropagation(); clearFile('ref'); });

            // 3. 模式切換
            els.modeUploadBtn.addEventListener('click', () => { state.bgSourceMode = 'upload'; updateUI(); });
            els.modePresetBtn.addEventListener('click', () => { state.bgSourceMode = 'preset'; updateUI(); });
            els.submodeCompositeBtn.addEventListener('click', () => { state.uploadSubMode = 'composite'; updateUI(); });
            els.submodeCompositionBtn.addEventListener('click', () => { state.uploadSubMode = 'composition'; updateUI(); });

            // 4. 生成與提示詞
            els.generateBtn.addEventListener('click', generateAll);
            els.customPrompt.addEventListener('input', (e) => { state.customPrompt = e.target.value; });

            function updateUI() {
                if (state.bgSourceMode === 'upload') {
                    els.modeUploadBtn.classList.replace('text-zinc-500', 'bg-white');
                    els.modeUploadBtn.classList.replace('hover:text-zinc-700', 'text-zinc-900');
                    els.modeUploadBtn.classList.add('shadow-sm');
                    els.modePresetBtn.classList.replace('bg-white', 'text-zinc-500');
                    els.modePresetBtn.classList.replace('text-zinc-900', 'hover:text-zinc-700');
                    els.modePresetBtn.classList.remove('shadow-sm');
                    els.uploadModeContent.classList.remove('hidden');
                    els.presetModeContent.classList.add('hidden');
                    els.customPrompt.placeholder = "例如: 增加一點桌面反光，讓畫面亮一點...";
                } else {
                    els.modeUploadBtn.classList.replace('bg-white', 'text-zinc-500');
                    els.modeUploadBtn.classList.replace('text-zinc-900', 'hover:text-zinc-700');
                    els.modeUploadBtn.classList.remove('shadow-sm');
                    els.modePresetBtn.classList.replace('text-zinc-500', 'bg-white');
                    els.modePresetBtn.classList.replace('hover:text-zinc-700', 'text-zinc-900');
                    els.modePresetBtn.classList.add('shadow-sm');
                    els.uploadModeContent.classList.add('hidden');
                    els.presetModeContent.classList.remove('hidden');
                    els.customPrompt.placeholder = "或輸入自定義場景描述...";
                }

                if (state.refImage) {
                    els.refPlaceholder.classList.add('hidden');
                    els.refPreviewContainer.classList.remove('hidden');
                    els.uploadSubmodeContainer.classList.remove('hidden');
                    els.refImg.src = state.refImage;
                    els.clearRefBtn.classList.remove('hidden');
                } else {
                    els.refPlaceholder.classList.remove('hidden');
                    els.refPreviewContainer.classList.add('hidden');
                    els.uploadSubmodeContainer.classList.add('hidden');
                    els.clearRefBtn.classList.add('hidden');
                }

                if (state.uploadSubMode === 'composite') {
                    els.submodeCompositeBtn.classList.add('bg-indigo-600', 'text-white');
                    els.submodeCompositeBtn.classList.remove('bg-white', 'text-zinc-500');
                    els.submodeCompositionBtn.classList.remove('bg-indigo-600', 'text-white');
                    els.submodeCompositionBtn.classList.add('bg-white', 'text-zinc-500');
                    els.submodeDesc.innerText = "• 適合空景照片。AI 會保留照片中的桌子/空間，直接把商品放進去。";
                } else {
                    els.submodeCompositionBtn.classList.add('bg-indigo-600', 'text-white');
                    els.submodeCompositionBtn.classList.remove('bg-white', 'text-zinc-500');
                    els.submodeCompositeBtn.classList.remove('bg-indigo-600', 'text-white');
                    els.submodeCompositeBtn.classList.add('bg-white', 'text-zinc-500');
                    els.submodeDesc.innerText = "• 適合有雜物的照片。AI 會將照片當作「構圖模版」，移除中間物體並填入您的商品。";
                }

                const canGenerate = state.productImage && (state.bgSourceMode === 'preset' || (state.bgSourceMode === 'upload' && state.refImage)) && !state.isLoading;
                els.generateBtn.disabled = !canGenerate;
                if (canGenerate) {
                    els.generateBtn.classList.remove('bg-zinc-100', 'text-zinc-400', 'cursor-not-allowed');
                    els.generateBtn.classList.add('bg-zinc-900', 'text-white', 'hover:bg-zinc-800');
                } else {
                    els.generateBtn.classList.add('bg-zinc-100', 'text-zinc-400', 'cursor-not-allowed');
                    els.generateBtn.classList.remove('bg-zinc-900', 'text-white', 'hover:bg-zinc-800');
                }

                if (state.bgSourceMode === 'upload') {
                    els.generateBtnText.innerText = state.uploadSubMode === 'composite' ? "合成至背景 + 4視角" : "替換主體 + 4視角";
                    els.previewTitle.innerText = state.uploadSubMode === 'composite' ? "Composite Result" : "Swap Result";
                } else {
                    els.generateBtnText.innerText = "生成預設場景 + 4視角";
                    els.previewTitle.innerText = "AI Generated Result";
                }

                if (state.productImage) {
                    els.productPlaceholder.classList.add('hidden');
                    els.productPreviewContainer.classList.remove('hidden');
                    els.productImg.src = state.productImage;
                    els.clearProductBtn.classList.remove('hidden');
                } else {
                    els.productPlaceholder.classList.remove('hidden');
                    els.productPreviewContainer.classList.add('hidden');
                    els.productImg.src = "";
                    els.clearProductBtn.classList.add('hidden');
                }

                if (state.isLoading) {
                    els.generateBtnText.innerText = "AI 運算中...";
                    els.previewEmpty.classList.add('hidden');
                    els.previewLoading.classList.remove('hidden');
                    els.mainResultImg.classList.add('hidden');
                } else if (state.generatedImage) {
                    els.generateBtnText.innerText = "重新生成";
                    els.previewEmpty.classList.add('hidden');
                    els.previewLoading.classList.add('hidden');
                    els.mainResultImg.classList.remove('hidden');
                    els.mainResultImg.src = state.generatedImage;
                    els.downloadMainBtn.classList.remove('hidden');
                    els.downloadMainBtn.onclick = () => downloadImage(state.generatedImage, 'main-scene.png');
                    renderVariations(els);
                }
                
                if(!state.isLoading) {
                    if(els.errorMsg.innerText === "") els.errorMsg.classList.add('hidden');
                }

                if (state.isAnalyzing) els.productAnalysisOverlay.classList.remove('hidden');
                else els.productAnalysisOverlay.classList.add('hidden');

                if (window.lucide) window.lucide.createIcons();
            }

            function renderPresets() {
                els.presetModeContent.innerHTML = SCENE_PRESETS.map((preset, idx) => `
                    <div onclick="window.selectPreset(${idx})" class="cursor-pointer rounded-xl border transition-all duration-200 p-3 flex flex-col gap-2 ${state.selectedPreset === idx ? 'border-zinc-900 bg-zinc-900 text-white shadow-md' : 'border-zinc-200 bg-white hover:border-zinc-300 hover:shadow-sm text-zinc-600'}">
                        <div class="flex items-center gap-2"><i data-lucide="${preset.icon}" class="w-4 h-4"></i><span class="text-xs font-bold truncate">${preset.name}</span></div>
                        <p class="text-[10px] leading-tight ${state.selectedPreset === idx ? 'text-zinc-300' : 'text-zinc-400'}">${preset.desc}</p>
                    </div>
                `).join('');
            }

            window.selectPreset = (idx) => { state.selectedPreset = idx; updateUI(); };

            function handleFile(e, type) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        if (type === 'product') {
                            state.productImage = reader.result;
                            state.generatedImage = null;
                            state.variations = [];
                            state.productName = "";
                            updateUI();
                            analyzeProductImage(state.productImage);
                        } else {
                            state.refImage = reader.result;
                            updateUI();
                        }
                    };
                    reader.readAsDataURL(file);
                }
            }

            function clearFile(type) {
                if (type === 'product') {
                    state.productImage = null;
                    state.productName = "";
                    state.generatedImage = null;
                    els.productSuggestions.innerHTML = "";
                } else {
                    state.refImage = null;
                }
                updateUI();
            }

            // ★關鍵修正：改用 gemini-1.5-flash★
            async function analyzeProductImage(base64) {
                state.isAnalyzing = true;
                updateUI();
                try {
                    const base64Data = base64.split(',')[1];
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ role: "user", parts: [{ text: "Identify the main product in this image. Provide 3 short, concise labels for it in Traditional Chinese. Return ONLY the 3 labels separated by commas." }, { inlineData: { mimeType: "image/png", data: base64Data } }] }]
                        })
                    });
                    
                    if (!response.ok) throw new Error(`API Error ${response.status}`);
                    
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if(text) {
                        const suggestions = text.split(/[,，、\n]/).map(s => s.trim()).filter(s => s.length > 0).slice(0, 3);
                        els.productSuggestions.innerHTML = suggestions.map(s => 
                            `<button onclick="window.setProductName('${s}')" class="flex items-center gap-1 px-2 py-1 rounded-full bg-indigo-50 text-indigo-700 text-[10px] hover:bg-indigo-100 transition-colors"><i data-lucide="sparkle" class="w-2.5 h-2.5"></i>${s}</button>`
                        ).join('');
                        if (window.lucide) window.lucide.createIcons();
                    }
                } catch (e) { 
                    console.error("Analysis failed:", e);
                }
                state.isAnalyzing = false;
                updateUI();
            }

            window.setProductName = (name) => {
                state.productName = name;
                els.productName.value = name;
            };

            async function generateAll() {
                state.isLoading = true;
                state.generatedImage = null;
                state.variations = [];
                els.errorMsg.classList.add('hidden');
                updateUI();

                const productBase64 = state.productImage.split(',')[1];
                const refBase64 = (state.bgSourceMode === 'upload' && state.refImage) ? state.refImage.split(',')[1] : null;
                const preset = SCENE_PRESETS[state.selectedPreset];
                const subjectLabel = state.productName.trim() ? `the ${state.productName}` : "the product object from Image 1";
                const qualityPrompt = "OUTPUT QUALITY: Photorealistic, 8k resolution, sharp focus, highly detailed texture. NO BLUR. NO ARTIFACTS.";

                let mainInstruction = "";
                if (state.bgSourceMode === 'upload' && refBase64) {
                    if (state.uploadSubMode === 'composite') {
                        mainInstruction = `TASK: High-Fidelity Composite of ${subjectLabel}.\n1. BACKGROUND: Use Image 2 exactly as is.\n2. SUBJECT: Insert ${subjectLabel} into Image 2.\n3. RELIGHTING: Re-light the product to match the lighting direction.\n4. SHADOWS: Generate deep, realistic contact shadows.\n5. NO CROPPING.\n${qualityPrompt}`;
                    } else {
                        mainInstruction = `TASK: High-Quality Object Swap.\nGOAL: Replace the central object in Image 2 with ${subjectLabel} from Image 1.\n1. SUBJECT: ${subjectLabel} is the ONLY hero.\n2. ERASE REFERENCE: Remove the object in Image 2.\n3. INSERT HERO: Place ${subjectLabel} there.\n4. INTEGRATION: Copy lighting and shadows.\n5. NEGATIVE PROMPT: Do not include the original object from Image 2.\n${qualityPrompt}`;
                    }
                } else {
                    mainInstruction = `TASK: Professional Product Photography of ${subjectLabel}.\n1. GENERATE a background that aligns with the product's angle using style: "${preset.name}".\n2. Description: ${preset.prompt}\n3. LIGHTING: Studio-quality lighting.\n${qualityPrompt}`;
                }
                if (state.customPrompt) mainInstruction += `\nADDITIONAL: ${state.customPrompt}`;

                try {
                    const mainUrl = await callGemini(mainInstruction, productBase64, refBase64, 0.25);
                    state.generatedImage = mainUrl;
                    state.isLoading = false;
                    updateUI();

                    VARIATION_ANGLES.forEach(async (angle) => {
                        let varPrompt = "";
                        if (state.bgSourceMode === 'upload' && refBase64) {
                            if (state.uploadSubMode === 'composite') {
                                varPrompt = `TASK: RE-IMAGINE the scene from a NEW ANGLE: ${angle.label}\n1. Source: Texture from Image 2.\n2. SUBJECT: ${subjectLabel}.\n3. RE-GEOMETRY: Re-draw background to match ${angle.label}.\n4. ${angle.instruction}\n${qualityPrompt}`;
                            } else {
                                varPrompt = `TASK: Create a product photo of ${subjectLabel} (from Image 1).\nSTRICT: You MUST draw ${subjectLabel}.\nFORBIDDEN: DO NOT draw the object from Image 2.\nTEXTURE ONLY: Extract ONLY the ground texture from Image 2.\nFORCE ANGLE: ${angle.instruction}\n${qualityPrompt}`;
                            }
                        } else {
                            varPrompt = `TASK: Create a product photo of ${subjectLabel} from angle: ${angle.label}\n1. FORCE ANGLE: ${angle.instruction}\n2. Background Style: ${preset.name}\n${qualityPrompt}`;
                        }

                        try {
                            const varUrl = await callGemini(varPrompt, productBase64, refBase64, 0.55);
                            state.variations.push({ label: angle.label, url: varUrl });
                            renderVariations(els);
                        } catch(e) { console.error(e); }
                    });

                } catch (e) {
                    state.isLoading = false;
                    els.errorMsg.innerText = "生成失敗: " + e.message + " (請檢查 Key 或網域設定)";
                    els.errorMsg.classList.remove('hidden');
                    updateUI();
                }
            }

            // ★修正：改用 gemini-1.5-flash 模型來生成圖片 (解決 403)★
            async function callGemini(prompt, img1, img2, temp) {
                const parts = [{ text: prompt }, { inlineData: { mimeType: "image/png", data: img1 } }];
                if (img2) parts.push({ inlineData: { mimeType: "image/png", data: img2 } });

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts }], generationConfig: { responseModalities: ["IMAGE"], temperature: temp } })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error ${response.status}`);
                }
                
                const result = await response.json();
                const b64 = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                if (!b64) throw new Error("No image generated (Model returned text only)");
                return `data:image/png;base64,${b64}`;
            }

            function renderVariations(els) {
                if (state.variations.length > 0) els.variationsSection.classList.remove('hidden');
                els.variationsGrid.innerHTML = state.variations.map((v, i) => `
                    <div class="group relative bg-white border-2 border-zinc-100 hover:border-zinc-300 rounded-xl overflow-hidden cursor-pointer transition-all" onclick="window.viewVariation('${v.url}')">
                        <div class="aspect-[4/3] overflow-hidden bg-zinc-50 flex items-center justify-center relative">
                            <img src="${v.url}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105">
                            <button onclick="event.stopPropagation(); window.downloadImage('${v.url}', 'var-${i}.png')" class="absolute top-2 right-2 p-2 bg-white/90 rounded-lg shadow hover:bg-zinc-200 transition-colors opacity-0 group-hover:opacity-100"><i data-lucide="download" class="w-4 h-4"></i></button>
                        </div>
                        <div class="p-3 bg-white border-t border-zinc-100">
                            <span class="text-xs font-bold text-zinc-800">${v.label}</span>
                            <span class="text-[10px] text-zinc-500 block mt-0.5">AI Re-rendered</span>
                        </div>
                    </div>
                `).join('');
                if (window.lucide) window.lucide.createIcons();
            }

            window.viewVariation = (url) => {
                state.generatedImage = url;
                const img = document.getElementById('main-result-img');
                const loading = document.getElementById('preview-loading');
                const empty = document.getElementById('preview-empty');
                const dlBtn = document.getElementById('download-main-btn');
                
                img.src = url;
                img.classList.remove('hidden');
                loading.classList.add('hidden');
                empty.classList.add('hidden');
                dlBtn.classList.remove('hidden');
                dlBtn.onclick = () => window.downloadImage(url, 'main-scene.png');
            };

            window.downloadImage = (url, name) => {
                const a = document.createElement('a');
                a.href = url;
                a.download = name;
                a.click();
            };

            init();
        });
